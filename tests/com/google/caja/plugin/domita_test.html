<!--
 - Copyright (C) 2008 Google Inc.
 -
 - Licensed under the Apache License, Version 2.0 (the "License");
 - you may not use this file except in compliance with the License.
 - You may obtain a copy of the License at
 -
 -      http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS,
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 - See the License for the specific language governing permissions and
 - limitations under the License.
-->
<html>
  <head>
    <title>Domita</title>
    <style type="text/css">
      .testcontainer { background: yellow; border: 2px solid yellow }
      .testcontainer.passed { background: #c0ffc0; border: 2px solid #c0ffc0 }
    </style>

    <script src="../cajita.js" onerror="console.error(this.src)"></script>
    <script src="jsunit.js"></script>
    <script src="asserts.js"></script>
    <script src="unicode.js" onerror="console.error(this.src)"></script>
    <script src="html4-defs.js" onerror="console.error(this.src)"></script>
    <script src="css-defs.js" onerror="console.error(this.src)"></script>
    <script src="html-sanitizer.js" onerror="console.error(this.src)"></script>
    <script src="bridal.js" onerror="console.error(this.src)"></script>
    <script src="html-emitter.js" onerror="console.error(this.src)"></script>
    <script src="domita.js" onerror="console.error(this.src)"></script>

  </head>

  <body onload="jsunitRun()" bgcolor="white">
    <div id="console-results"></div>

    <script type="text/javascript">
      function loadScript(src) {
        document.write(
            '<script src="' + html.escapeAttrib(src) + '"'
            + ' onerror="console.error(this.src)"><\/script>');
      }

      var isValija = /[&?]valija([=&]|$)/.test(location.search);
    </script>

    <script type="text/javascript">
    var valijaMaker;
    (function () {
      if (isValija) {
        var testImports = ___.copy(___.sharedImports);
        testImports.loader = ___.freeze({
              provide: ___.simpleFunc(function (v) { valijaMaker = v; })
            });
        ___.getNewModuleHandler().setImports(testImports);
        loadScript('valija-cajoled.js');
      }
    })();</script>

    <script type="text/javascript">(function () {
      var testImports = ___.copy(___.sharedImports);
      if (valijaMaker) { testImports.$v = valijaMaker(testImports); }

      ___.getNewModuleHandler().setImports(testImports);
      attachDocumentStub(
           '-xyz___',
           {
             rewrite:
                 function (uri, mimeType) {
                   if (!/^https?:\/\//i.test(uri)) { return null; }
                   return 'http://gadget-proxy/?url=' + encodeURIComponent(uri)
                       + '&mimeType=' + encodeURIComponent(mimeType);
                 }
           },
           testImports);
      console.log('attached stubs');

      testImports.jsunitRegister = ___.simpleFunc(jsunitRegister);
      testImports.console = ___.primFreeze({
        log: ___.simpleFrozenFunc(
            function () { console.log.apply(console, arguments); }),
        warn: ___.simpleFrozenFunc(
            function () { console.warn.apply(console, arguments); }),
        error: ___.simpleFrozenFunc(
            function () { console.error.apply(console, arguments); }),
        trace: ___.simpleFrozenFunc(
            function () {
              console.trace ? console.trace()
                  : console.error.apply(console, arguments);
            })
      });

      // Give unfiltered DOM access so we can check the results of actions.
      testImports.directAccess = ___.primFreeze({
        // Allow testing of emitHtml by exposing it for testing
        emitCssHook: ___.simpleFrozenFunc(function (css) {
          testImports.emitCss___(css.join('xyz___'));
        }),
        getInnerHTML: ___.simpleFrozenFunc(function (tameNode) {
          return tameNode.node___.innerHTML;
        }),
        getAttribute: ___.simpleFrozenFunc(function (tameNode, name) {
          return tameNode.node___.getAttribute(name);
        }),
        getComputedStyle: ___.simpleFrozenFunc(function (tameNode, styleProp) {
          var node = tameNode.node___;
          if (node.currentStyle) {
            return node.currentStyle[styleProp];
          } else if (window.getComputedStyle) {
            return document.defaultView.getComputedStyle(node, null)
                .getPropertyValue(styleProp);
          }
        }),
        // TODO(mikesamuel): remove once HTML in this class is cajoled properly
        getHtmlEmitter: ___.simpleFrozenFunc(function (tameBaseNode) {
          var tameEmitter = {};
          var emitter = new HtmlEmitter(tameBaseNode.node___);
          for (var k in emitter) {
            if (!/_$/.test(k) && 'function' === typeof emitter[k]) {
              tameEmitter[k] = (function (k) {
                    return ___.simpleFrozenFunc(function (var_args) {
                      emitter[k].apply(emitter, arguments);
                      return tameEmitter;
                    });
                  })(k);
            }
          }
          return tameEmitter;
        })
      });

      // Marks a container green to indicate that test passed
      testImports.pass = ___.simpleFunc(function (id) {
        var node = testImports.document.getElementById(id);
        if (!node) { console.trace(); }
        node = node.node___;
        node.appendChild(document.createTextNode('Passed ' + id));
        node.className = (node.className || '') + ' passed';
      }, 'pass');

      // Create a readonly mirror of document so that we can test that mutations
      // fail when they should.
      testImports.documentRO = new testImports.document.constructor(
          document, false);

      window.toString = function () { return '[WINDOW]'; };
    })();</script>

    <script type="text/javascript">
    loadScript(isValija ? 'domita_test_valijad.js' : 'domita_test_cajoled.js');
    </script>

    <div id="test-get-element-by-id-xyz___" class="testcontainer"></div>
    <div id="test-get-element-by-id-2-xyz___" class="testcontainer"></div>

    <div id="foo"></div>

    <p id="test-element-id-xyz___" class="testcontainer"></p>

    <p id="test-create-element-xyz___" class="testcontainer"></p>

    <div id="test-inner-html-xyz___" class="testcontainer"
     ><a id="bar" href="http://foo.com?a=b&c=d" class="link" title="<click me!>"
       target="_parent">Test <em id="em-xyz___">Not</em>> run yet.</a>
    </div>

    <div class="testcontainer" id="test-forms-xyz___"></div>

    <div class="testcontainer" id="test-no-script-xyz___"></div>

    <p class="testcontainer" id="test-add-event-listener-xyz___">
      <b>click me</b>
    </p>

    <p class="testcontainer" id="test-remove-event-listener-xyz___">
      <b>click me</b>
    </p>

    <ol class="testcontainer" id="test-get-elements-by-tag-name-xyz___">
      <li>One
      <li>Two
      <li>Three
        <ol><li>Pi</li><li>sqrt(10)</li></ol>
    </ol>

    <div class="testcontainer" id="test-dynamic-styles-xyz___">
      <span id="test-dynamic-styles1-xyz___">I should be bold</span><br>
      <span id="test-dynamic-styles2-xyz___" style="font-weight: bold"
       >I should not be bold</span><br>
      <span id="test-dynamic-styles3-xyz___"
       >There's no such thing as super-bold</span><br>
    </div>

    <p class="testcontainer" id="test-read-only-xyz___">
      <span id="indelible-xyz___">I am indelible</span>
    </p>

    <p class="testcontainer" id="test-insert-before-xyz___">zero</p>

    <ul class="testcontainer" id="test-node-lists-xyz___"
     ><li>One<li><b>Two</b><li>Three</ul>

    <div class="testcontainer" id="test-name-attr-xyz___"></div>

    <div class="testcontainer" id="test-target-attr-xyz___"></div>

    <div class="testcontainer" id="test-location-xyz___"></div>

    <div class="testcontainer" id="test-navigator-xyz___"></div>

    <div class="testcontainer" id="test-opaque-nodes-xyz___"
     ><!-- Comment -->a<script></script>b<object></object>c</div>

    <p class="testcontainer" id="test-child-nodes-xyz___"></p>

    <div class="xyz___">
      <div class="testcontainer" id="test-emit-css-xyz___">
        <a id="not-blue-xyz___" href="#">I am not blue</a>
      </div>
    </div>

    <p class="testcontainer" id="test-bug-731-xyz___"
     >The input should be a radio button: </p>

    <p class="testcontainer" id="test-dom-class-hierarchy-xyz___">
      <b>Click me</b>
    </p>

    <div class="testcontainer" id="test-case-insensitive-attrs-xyz___">
      <table id="is-red-xyz___">
        <tr>
          <td><strong>Click me if this is red</strong></td>
        </tr>
      </table>
    </div>

  </body>
</html>
