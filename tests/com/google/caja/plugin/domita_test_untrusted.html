<!--
  - Copyright (C) 2008 Google Inc.
  -
  - Licensed under the Apache License, Version 2.0 (the "License");
  - you may not use this file except in compliance with the License.
  - You may obtain a copy of the License at
  -
  -      http://www.apache.org/licenses/LICENSE-2.0
  -
  - Unless required by applicable law or agreed to in writing, software
  - distributed under the License is distributed on an "AS IS" BASIS,
  - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  - See the License for the specific language governing permissions and
  - limitations under the License.
 -->

<style type="text/css">
  .testcontainer { background: yellow; border: 2px solid yellow }
  .clickme { border: 2px solid fuchsia; }
  .waiting { border: 2px solid aqua; }
  .manual { background: #eef; border: 2px solid #00f; }
  .passed { background: #c0ffc0; border: 2px solid #c0ffc0 }
  .invisible { display: none; float: left }
  .inline { display: inline }
</style>

<p class="manual testcontainer" id="test-related-target-mouse-container">
  <span id="test-related-target-mouse">
    Move mouse here to see event.relatedTarget.
    Rapid motion from outside sandbox should show a null relatedTarget.
  </span>
  <br />
  <span id="test-related-target-mouse-info">&nbsp;</span>
</p>

<p class="clickme testcontainer" id="test-related-target">
  <b id="test-related-target-child">click me (test-related-target)
  </b>
</p>

<p class="clickme testcontainer" id="test-add-event-listener">
  <b id="test-add-event-listener-label">click me</b>
</p>

<p class="clickme testcontainer" id="test-remove-event-listener">
  <b id="test-remove-event-listener-label">click me</b>
</p>

<p class="clickme testcontainer" id="test-dom-class-hierarchy">
  <b>Click me</b>
</p>

<p class="clickme testcontainer" id="test-innerhtml-onclick">
  <b>do not click yet</b>
</p>

<div class="clickme testcontainer" id="test-case-insensitive-attrs">
  <table id="is-red">
    <tr>
      <td><strong>Click me if this is red</strong></td>
    </tr>
  </table>
</div>

<!-- form element named 'id' triggers bug 1090. -->
<!-- NOTE, this form must be first, otherwise ff3.5.x will produce
     false passes due to an optimizer bug.
     https://bugzilla.mozilla.org/show_bug.cgi?id=508744 -->
<div class="testcontainer" id="test-emitter-id">
  <script>921</script>
  <form id="test-emitter-id-0">
    <input id="test-emitter-id-1" name="id" value="pigeon">
  </form>
</div>

<!-- This should be the second test case with any FORM nodes in it,
     so the tests get predictable results. -->
<form class="testcontainer" id="test-document-forms">Form 0</form>

<form class="testcontainer" id="test-form-elements">
  <input type="checkbox" name="a">
  <input type="checkbox" name="a">
  <input type="checkbox" name="a">
  <button type="button" name="b">Button B 0</button>
  <button type="button" name="b">Button B 1</button>
  <button type="button" name="b">Button B 2</button>
  <input type="checkbox" name="c">
</form>

<form id="test-onreset-form">
  <div class="clickme testcontainer" id="test-onreset">
    <input type="reset" value="click me">
  </div>
</form>

<p class="clickme testcontainer" id="test-onclick-handler">
  <b id="test-onclick-handler-label"
     onclick="pass('test-onclick-handler');">click me</b>
</p>

<p class="clickme testcontainer" id="test-current-target">
  <b id="test-current-target-child">click me</b>
</p>

<p class="waiting testcontainer" id="test-timeout-and-interval">
  Timeouts and Intervals<br>
</p>

<br>

<div class="testcontainer" id="test-document-write">
  <div>
    <p>Before <code>document.write</code></p>
    <script type="text/javascript">
      document.write(
          '<p id=test-document-write-foo>Document written<\/p></div><div>',
          '<p>Written afterwards<p>More written afterwards');
    </script>
    <p>After <code>document.write</code>
  </div>
</div>
<br>

<div class="testcontainer" id="test-attrs-declared-in-markup"
    ><form title="test title"></form>
  <b>Test attributes in markup</b>
</div>

<div class="testcontainer" id="test-attrs-not-in-markup"
    ><form></form>
  <b>Test attributes not in markup</b>
</div>

<div class="testcontainer" id="test-attrs-nonstandard-permitted"
    ><form></form>
  <b>Test attributes nonstandard permitted</b>
</div>

<p class="testcontainer" id="test-property-attribute-interaction">
  <span id="test-property-attribute-interaction-label">
    Test property attribute interaction
  </span><br>
</p>

<div class="testcontainer" id="test-form-length"
  ><form id="test-form-length-form">
    <input type="text">
    <button></button>
  </form>
</div>

<p class="testcontainer" id="test-pseudo-elements">
  Test pseudo-elements
</p>

<p class="testcontainer" id="test-editability-in-node-lists">
  editability in node lists<br>
</p>

<p class="testcontainer" id="test-nonexistent-style-property">
  <span id="test-nonexistent-style-property-label"
   >I ain&apos;t got no style</span>
  <br>
</p>

<div id="test-get-element-by-id" class="testcontainer"></div>

<div id="test-get-element-by-id-2" class="testcontainer"></div>

<p id="test-contains" class="testcontainer"></p>

<p id="test-element-id" class="testcontainer"></p>

<p id="test-create-element" class="testcontainer"></p>

<div class="testcontainer" id="test-forms"></div>

<p class="testcontainer" id="test-script-loading">Test script loading</p>

<ol class="testcontainer" id="test-get-elements-by-tag-name">
  <li>One
  <li>Two
  <li>Three
    <ol><li>Pi</li><li>sqrt(10)</li></ol>
</ol>

<!--
  - The getElementsByClassName tests are derived from those at
  - http://code.google.com/p/doctype/wiki/DocumentGetElementsByClassNameMethod
  - which are themselves derived from the HTML5 spec.
 -->
<div class="testcontainer" id="test-get-elements-by-class-name">
  <p class="aaa bbb">AAA BBB</p>
  <div class="aaa">AAA</div>
  <p class="bbb ccc">BBB CCC</p>
</div>

<p class="testcontainer" id="test-class-set-by-emitter"></p>

<div class="testcontainer" id="test-dynamic-styles">
  <span id="test-dynamic-styles1">I should be bold</span><br>
  <span id="test-dynamic-styles2" style="font-weight: bold"
   >I should not be bold</span><br>
  <span id="test-dynamic-styles3"
   >There&apos;s no such thing as super-bold</span><br>
</div>

<p class="testcontainer" id="test-special-style-names">
  (<span>(fluffy (little) cloud)</span>)
</p>

<p class="testcontainer" id="test-read-only">
  <span id="indelible">I am indelible</span>
</p>

<p class="testcontainer" id="test-remove-child"
  >hello<span id="test-remove-child-1">world</span></p>

<p class="testcontainer" id="test-replace-child"
  ><span id="test-replace-child-1">alpha</span
  >bravo<span id="test-replace-child-2">charlie</span></p>

<p class="testcontainer" id="test-insert-before">zero</p>

<ul class="testcontainer" id="test-node-lists"
 ><li>One<li><b>Two</b><li>Three</ul>

<div class="testcontainer" id="test-name-attr"></div>

<div class="testcontainer" id="test-target-attr"></div>

<div class="testcontainer" id="test-location">
  test-location
</div>

<div class="testcontainer" id="test-navigator"></div>

<p class="testcontainer" id="test-child-nodes"></p>

<div class="testcontainer" id="test-emit-css">
  <a id="not-blue" href="#">I am not blue</a>
</div>

<div class="testcontainer" id="test-bug-731"
 >The input should be a radio button:
<form><input id="bug-731" type="radio" /></form></div>

<p class="testcontainer" id="test-bug-920"><input id="bug-920" /></p>

<p class="testcontainer" id="test-array-slice">test-array-slice</p>
<p class="testcontainer" id="test-browser-apply">test-browser-apply</p>
<p class="testcontainer" id="test-xo4a-apply">test-xo4a-apply</p>

<br>

<form class="testcontainer" id="test-input-default-values">
  <input type="text" value="one">
  <input id="x" type="text" value="two">
  <input checked type="checkbox">
  <input type="checkbox">
</form>

<p class="testcontainer" id="test-event-handler-attributes">
  <input onclick="autoclicky.click(0)" id="autoclicker" type="checkbox">
  <input id="set-onclick-on-me" type="checkbox">
</p>

<p class="testcontainer" id="test-event-listeners-on-document">
  <input type="checkbox">
</p>

<p class="testcontainer" id="test-onload-listener">Onload</p>

<p class="testcontainer" id="test-inner-HTML-style-sanitizer"></p>

<p class="testcontainer" id="test-offset-parent" style="position:relative">
<span id="test-offset-parent-inner">inner</span>
</p>

<div class="testcontainer" id="test-whitespace-nodes-1">
  <div style="width: 150px; border: 1px solid blue; margin: 0; padding: 2px"
   id="whitespace-outer">
    <p class="redp" style="margin: 10px; border: 1px dotted red; padding: 2px"
     >hi</p>
    <p class="redp" style="margin: 10px; border: 1px dotted red; padding: 2px"
     >hi</p>
  </div>
  <p id="text-only" style="margin: 0; border-width: 0; padding: 0">hi</p>
</div>

<div class="testcontainer" id="test-whitespace-nodes-2" style="padding: 0px">
  <div id="twn2-0">
   <p style="margin: 0; border-width: 0; padding: 0">hi</p>
  </div>
  <p style="margin: 0; border-width: 0; padding: 0" id="twn2-1">hi</p>
</div>

<form class="testcontainer" id="test-radio-buttons">
  <input type="radio" value="0" id="test-radio-button-0" name="number" checked>
  <input type="radio" value="1" id="test-radio-button-1" name="number">
  <input type="radio" value="2" id="test-radio-button-2" name="number">
</form>

<p class="testcontainer" id="test-props-on-nodes">Original Text</p>

<div class="testcontainer" id="test-xhr-sync">XHR sync</div>

<div class="waiting testcontainer" id="test-xhr-async">XHR async</div>

<div class="testcontainer" id="test-computed-style">
  <div id="test-computed-style-block">Block</div>
  <span id="test-computed-style-inline">Inline</span>
  <div id="test-computed-style-fakie" style="display: inline">???</div>
  <div id="test-computed-style-invisible" class="invisible">Not here</div>
</div>

<div class="testcontainer" id="test-set-style"
     style="cursor:move">test-set-style</div>

<div>Before
<p class="testcontainer" id="test-class-names">I am inline.</p>
After
</div>

<div class="testcontainer" id="test-illegal-suffixes"></div>

<div class="testcontainer" id="test-id-refs-rewriting"></div>

<div class="testcontainer" id="test-strange-ids"></div>

<div class="testcontainer" id="test-clone-node-structure">
  <p>I have <b title="I have attributes">content</b></p>
</div>

<p class="testcontainer" id="test-compat-mode">Compat Mode:</p>

<div class="testcontainer" id="test-clone-node-listeners">
  <input id="test-clone-node-clickable" type="checkbox">
</div>

<div class="testcontainer" id="test-clone-node-defaults">
  <form>
    I should reset to the proper state.
    <input value="default" name="text">
    <input type="checkbox" checked name="checkbox_checked" value="on">
    <input type="checkbox" name="checkbox_unchecked" value="on">
    <input type="radio" name="radio" value="A">
    <input type="radio" name="radio" checked value="B">
    <select name="selectlist">
      <option selected value="1">1</option>
      <option value="2">2</option>
    </select>
  </form>
</div>

<p class="testcontainer" id="test-clone-node-custom-attrs">
  I will have a custom attribute
</p>

<p class="testcontainer" id="test-custom-events">Custom Events<br></p>

<p class="testcontainer" id="test-domita-globals-accessible">
  Test Domita globals accessible
</p>

<p class="testcontainer" id="test-factories-not-bypassable">
  Test factories not bypassable
</p>

<p class="testcontainer" id="test-scrolling"><nobr
>A really looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong
line that will force the viewport to have a horizontal scroll bar so that we
can test window.scrollBy with a positive x value with a visible effect.
</nobr><br></p>

<p class="testcontainer" id="test-resizing">Resizing</p>

<div class="testcontainer" id="test-size-properties"
 style="
    width: 100px;
    height: 50px;
    border: 2px solid black;
    padding: 3px;
    margin: 7px"
 ></div>

<p class="testcontainer" id="test-default-view">Test document.defaultView</p>

<p class="testcontainer" id="test-document-element">Test Document Element</p>

<p class="testcontainer" id="test-window-object">Test Window Object</p>

<p class="testcontainer" id="test-bounding-client-rect"
>Test Bounding Client Rect</p>

<p class="testcontainer" id="test-attribute-nodes">
  <input id="test-attribute-nodes-onclick" type="checkbox" onclick="return 0;">
  Test Attribute Nodes
</p>

<p class="testcontainer" id="test-shorthand-css"
 >Test shorthand css</p>

<p class="testcontainer" id="test-anchor-computed-styles-dont-leak-history">
  Test anchor computed styles don't leak history
</p>

<div class="testcontainer" id="test-table-elements">
  <table>
    <thead>
      <tr>
        <td>h00</td>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>b00</td>
        <td>b01</td>
      </tr>
      <tr id="test-table-elements-tr-b1">
       <td>b10</td>
       <td>b11</td>
      </tr>
    </tbody>
  </table>
</div>

<p class="testcontainer" id="test-focus-blur"
 ><input id="test-focus-blur-1">
</p>

<p class="testcontainer" id="test-this-in-event-handlers"
 ><input type="checkbox" id="test-this-in-event-handlers-1" />
</p>

<p class="testcontainer" id="test-for-attribute">for attribute</p>

<div class="testcontainer" id="test-row-cell">
Test row cell
  <table id="test-row-cell-1">
    <tbody id="test-row-cell-2"></tbody>
  </table>
</div>

<p class="testcontainer" id="test-negative-indices">Test negative indices</p>

<div class="testcontainer" id="test-iframe-shim">Test Iframe Shim</div>

<!-- this sequence of interleaved html/text/script triggers bug 1060 -->
<div class="testcontainer" id="test-emitter-ie">
  <div id="test-emitter-ie-0">duck-0</div>duck-2
  <script>1</script>
  <div id="test-emitter-ie-1">duck-1</div>duck-3
  <script>2</script>
  duck-4
</div>

<p class="waiting testcontainer" id="xhr-module-loader">XHR Module Loader</p>

<p class="waiting testcontainer" id="script-module-loader">Script Module Loader</p>

<p class="waiting testcontainer" id="xhr-module-loader-2">
XHR Module Loader 2</p>

<p class="waiting testcontainer" id="script-module-loader-2">
Script Module Loader 2</p>

<p class="waiting testcontainer" id="xhr-module-loader-failure">
XHR Module Loader Failure</p>

<p class="waiting testcontainer" id="script-module-loader-failure">
Script Module Loader Failure</p>

<p class="waiting testcontainer" id="recursive-module">
Recursive Module</p>

<p class="waiting testcontainer" id="common-js-module">CommonJS Module</p>

<p class="waiting testcontainer" id="common-js-recursive-module">
CommonJS Recursive Module</p>

<p class="waiting testcontainer" id="xhr-unbundled-module-loader">
XHR Unbundled Module Loader</p>

<p class="waiting testcontainer" id="script-unbundled-module-loader">
Script Unbundled Module Loader</p>

<p class="waiting testcontainer" id="static-common-js-module">
Static CommonJS Module</p>

<p class="testcontainer" id="test-usemap"
><map name="foo"><area href="areatarget.html"
></map
><img usemap="#foo" src="mappic.gif"></p>

<p class="testcontainer" id="test-document-body-appendChild"
 >I should be the last element until something is appended to document.body</p>

<script type="text/javascript">
// We wish to test Domita under access from Valija, and from Cajita. To that
// end, the build.xml rules generate two versions of this file by textually
// substituting for the below comment:
//
//   * Nothing, so this SCRIPT is cajoled as Valija.
//
//   * A complete 'use cajita' directive prologue, so this SCRIPT is
//     cajoled as Cajita.

/*@@cajaLanguageSelectionStatements@@*/

/** Aim high and you might miss the moon! */
function expectFailure(shouldFail, opt_msg, opt_failFilter) {
  try {
    shouldFail();
  } catch (e) {
    if (opt_failFilter && !opt_failFilter(e)) { throw e; }
    console.log('Caught expected failure ' + e + ' (' + e.message + ')');
    return;
  }
  fail(opt_msg || 'Expected failure');
}

function assertFailsSafe(canFail, assertionsIfPasses) {
  try {
    canFail();
  } catch (e) {
    return;
  }
  assertionsIfPasses();
}

function assertColor(expected, cssColorString) {
  if (typeof cssColorString === 'string') {
    cssColorString = cssColorString.toLowerCase();
  }
  if (cssColorString === expected.name) { return; }
  var hexSix = expected.rgb.toString(16);
  while (hexSix.length < 6) { hexSix = '0' + hexSix; }
  if (cssColorString === '#' + hexSix) { return; }
  var hexThree = hexSix.charAt(0) + hexSix.charAt(2) + hexSix.charAt(4);
  if (cssColorString === '#' + hexThree) { return; }

  var stripped = cssColorString.replace(new RegExp(' ', 'g'), '');
  if (('rgb(' + (expected.rgb >> 16)
       + ',' + ((expected.rgb >> 8) & 0xff)
       + ',' + (expected.rgb & 0xff) + ')') === stripped) {
    return;
  }

  fail(cssColorString + ' != #' + hexSix);
}

/**
 * Checks the structure of a DOM structure against a skeleton describing
 * details of the node.
 * @param skeleton an acyclic Object whose own properties describe aspects
 *   of the node such as 'nodeType', 'tagName', etc.  See the switch for
 *   supported member names.
 * @param node the node to check against skeleton.
 */
function assertDomTree(skeleton, node, opt_stack) {
  var stack = opt_stack || '(#root:' + node.nodeName + ')';
  cajita.forOwnKeys(
      skeleton,
      function (key) {
        var msg = stack + ':' + key;
        var v = skeleton[key];
        switch (key) {
          case 'nodeType':
            assertEquals(msg, v, node.nodeType);
            break;
          case 'nodeName':
            assertEquals(msg, v, node.nodeName);
            break;
          case 'nodeValue':
            assertEquals(msg, v, node.nodeValue);
            break;
          case 'tagName':
            assertEquals(msg, v, node.tagName);
            assertEquals(msg, v, node.nodeName);
            break;
          case 'innerHTML':
            assertEquals(msg, v, node.innerHTML);
            break;
          case 'sameAs':
            assertEquals(msg, v, node);
            break;
          case 'attributes':
            var attrs = node.attributes;
            var specified = [];
            var names = [];
            for (var i = 0, n = attrs.length; i < n; ++i) {
              var attr = attrs[i];
              if (attr.specified) {
                specified.push(attr);
                names.push(attr.name);
              }
            }
            assertEquals(
                msg + ' #attrs (' + names + ')', v.length, specified.length);
            for (var i = 0, n = v.length; i < n; ++i) {
              assertDomTree(
                  v[i], specified[i],
                  stack + '@(#' + i + ':' + specified[i].nodeName + ')');
            }
            break;
          case 'children':
            var children = node.childNodes;
            assertEquals(msg + ' #children', v.length, children.length);
            for (var i = 0, n = v.length; i < n; ++i) {
              assertDomTree(
                  v[i], children[i],
                  stack + '/(#' + i + ':' + children[i].nodeName + ')');
            }
            for (var i = 0, n = v.length, c = node.firstChild; i < n;
                 ++i, c = c.nextSibling) {
              // TODO(mikesamuel): enable for all node-types once EQ fixed on IE
              if (c.nodeType === 1) {
                assertEquals(msg + ' firstChild check ' + i, c, children[i]);
              }
            }
            for (var i = n = v.length, c = node.lastChild; --i >= 0;
                 c = c.previousSibling) {
              // TODO(mikesamuel): enable for all node-types once EQ fixed on IE
              if (c.nodeType === 1) {
                assertEquals(msg + ' lastChild check' + i, c, children[i]);
              }
            }
            break;
          default:
            fail(msg + ' unrecognized key');
            break;
        }
      });
}

/**
 * Canonicalize well formed innerHTML output, by making sure that attributes
 * are ordered by name, and have quoted values.
 *
 * Without this step, it's impossible to compare innerHTML cross-browser.
 */
function canonInnerHtml(s) {
  // Sort attributes.
  var htmlAttribute = new RegExp(
      '\\s*(\\w+)(?:\\s*=\\s*("[^\\"]*"|\'[^\\\']*\'|[^\\\'\\"\\s>]+))?');
  var quot = new RegExp('"', 'g');
  var tagBody = '(?:"[^"]*"|\'[^\']*\'|[^>"\']+)*';
  var htmlStartTag = new RegExp('(<\\w+)(' + tagBody + ')>', 'g');
  var htmlTag = new RegExp('(<\/?)(\\w+)(' + tagBody + ')>', 'g');
  var ignorableWhitespace = new RegExp('^[ \\t]*(\\r\\n?|\\n)|\\s+$', 'g');
  var tagEntityOrText = new RegExp(
      '(?:(</?\\w[^>]*>|&[a-zA-Z#]|[^<&>]+)|([<&>]))', 'g');
  s = s.replace(
      htmlStartTag,
      function (_, tagStart, tagBody) {
        var attrs = [];
        for (var m; tagBody && (m = tagBody.match(htmlAttribute));) {
          var name = m[1];
          var value = m[2];
          var hasValue = value != null;
          if (hasValue && (new RegExp('^["\']')).test(value)) {
            value = value.substring(1, value.length - 1);
          }
          attrs.push(
              hasValue
              ? name + '="' + value.replace(quot, '&quot;') + '"'
              : name);
          tagBody = tagBody.substring(m[0].length);
        }
        attrs.sort();
        return tagStart + ' ' + attrs.join(' ') + '>';
      });
  s = s.replace(
      htmlTag,
      function (_, open, name, body) {
        return open + name.toLowerCase() + (body || '') + '>';
      });
  // Remove ignorable whitespace.
  s = s.replace(ignorableWhitespace, '');
  // Normalize escaping of text nodes since Safari doesn't escape loose >.
  s = s.replace(
      tagEntityOrText,
      function (_, good, bad) {
        return good
            ? good
            : (bad.replace(new RegExp('&', 'g'), '&amp;')
               .replace(new RegExp('>', 'g'), '&gt;'));
      });
  return s;
}

jsunitRegister('testTimeoutAndInterval',
               function testTimeoutAndInterval() {
  var timeout1Ran = false,
      timeout2Ran = false;
  var timeout1Id = setTimeout(jsunitCallback(
      function to1Id() { timeout1Ran = true; }), 50);
  var timeout2Id = setTimeout(jsunitCallback(
      function to2Id() { timeout2Ran = true; }), 50);
  clearTimeout(timeout1Id);

  var intervalRunIndex = -1;
  var interval1RunCount = 0,
      interval2RunCount = 0;
  var interval1Id = setInterval(jsunitCallback(
      function iv1id() { ++interval1RunCount; }), 50);
  var interval2Id = setInterval(jsunitCallback(
      function iv2id() { ++interval2RunCount; }), 50);

  // Check that null is a noop as a timeout or interval value, and that the
  // return value works with clearTimeout and clearInterval and does not
  // inadvertently clear existing timeouts or intervals.
  clearTimeout(setTimeout(null, 0));
  clearInterval(setInterval(null, 0));

  // Check that clearInterval and clearTimeout ignore null
  // and undefined intervalId's
  clearInterval(null);
  clearInterval(void 0);
  clearTimeout(null);
  clearTimeout(void 0);

  setTimeout(
      jsunitCallback(function () {
        clearInterval(interval2Id);
        setTimeout(
            jsunitCallback(function () {
              if (!timeout1Ran && timeout2Ran
                  && interval1RunCount > interval2RunCount) {
                clearInterval(interval1Id);
                pass('test-timeout-and-interval');
              }
            }),
            500);
      }),
      200);
});

// These "click me" tests should be early on so they're easy to find on the
// HTML page.
jsunitRegister('testAddEventListener',
               function testAddEventListener() {
  var container = document.getElementById('test-add-event-listener-label');
  container.addEventListener(
      'click',
      jsunitCallback(
          function eventListener(event) {
            console.log('received event');
            assertEquals('B', event.target.tagName);
            assertEquals('click', event.type);
            pass('test-add-event-listener');
          }));
  expectFailure(
      function() {
        container.addEventListener('foo');
      },
      'addEventListener of a string');
  expectFailure(
      function() {
        container.addEventListener({});
      },
      'addEventListener of an ordinary object');
});

jsunitRegister('testRemoveEventListener',
               function testRemoveEventListener() {
  var container = document.getElementById('test-remove-event-listener-label');
  var firstFired = false;
  var failed = false;
  var second = jsunitCallback(
      function secondcb(event) {
        console.log('received event');
        if (failed) { return; }
        assertEquals('B', event.target.tagName);
        assertEquals('click', event.type);
        event.target.innerHTML = 'All done!';
        pass('test-remove-event-listener');
      });
  var first = jsunitCallback(
      function firstcb(event) {
        if (firstFired) {
          event.target.innerHTML =
              '<b>FAILED - event handler was not removed!</b>';
          failed = true;
          return;
        }
        firstFired = true;
        console.log('received event');
        assertEquals('B', event.target.tagName);
        assertEquals('click', event.type);
        event.target.innerHTML = 'Thank you, click me again please';
        container.removeEventListener('click', first);
        container.addEventListener('click', second);
      });
  container.addEventListener('click', first);
});

jsunitRegister('testDomClassHierarchy',
               function testDomClassHierarchy() {
  assertTrue('document < Node', document instanceof window.Node);
  assertTrue('document < HTMLDocument',
             document instanceof window.HTMLDocument);

  assertTrue('<DIV> < Node',
             document.createElement('div') instanceof window.Node);
  assertTrue('<DIV> < Element',
             document.createElement('div') instanceof window.Element);
  assertTrue('<DIV> < HTMLDivElement',
             document.createElement('div') instanceof window.HTMLDivElement);

  assertTrue('<INPUT> < Node',
             document.createElement('input') instanceof window.Node);
  assertTrue('<INPUT> < Element',
             document.createElement('input') instanceof window.Element);
  assertTrue('<INPUT> < HTMLInputElement',
             document.createElement('input')
             instanceof window.HTMLInputElement);

  assertTrue('<A> < Node', document.createElement('a') instanceof window.Node);
  assertTrue('<A> < Element',
             document.createElement('a') instanceof window.Element);
  assertTrue('<A> < HTMLAnchorElement',
             document.createElement('a') instanceof window.HTMLAnchorElement);

  assertTrue('<IMG> < Node',
             document.createElement('img') instanceof window.Node);
  assertTrue('<IMG> < Element',
             document.createElement('img') instanceof window.Element);
  assertTrue('<IMG> < HTMLImageElement',
             document.createElement('img') instanceof window.HTMLImageElement);

  // TODO(ihab.awad): Add negative tests when virtual hierarchy is improved:
  //assertFalse('<IMG> !< HTMLDivElement',
  //            document.createElement('img') instanceof window.HTMLDivElement);

  document.getElementById('test-dom-class-hierarchy').addEventListener(
      'click',
      jsunitCallback(
          function onclick(event) {
            assertTrue(event instanceof window.Event);
            pass('test-dom-class-hierarchy');
          }));
});

jsunitRegister('testInnerhtmlOnclick',
               function testInnerhtmlOnclick() {
  var el = document.getElementById('test-innerhtml-onclick');
  if (directAccess.isValija) {
    el.innerHTML = '<b onclick="innerhtmlClicked();">Click me</b>';
  } else {
    // in cajita, innerhtmlClicked is a local module function,
    // and there's no way for domita.js to access it.
    el.innerHTML = "<span>Cajita can't link up onclick= functions</span>";
    pass('test-innerhtml-onclick');
  }
});

function innerhtmlClicked() {
  pass('test-innerhtml-onclick');
}

jsunitRegister('testCaseInsensitiveAttrs',
               function testCaseInsensitiveAttrs() {
  var tableNode = document.getElementById('is-red');
  tableNode.setAttribute('bgColor', 'red');
  tableNode.addEventListener(
      'click',
      jsunitCallback(
          function onclick(event) {
            pass('test-case-insensitive-attrs');
          }));
});

jsunitRegister('testDocumentForms',
               function testDocumentForms() {
  var df = document.forms;
  assertEquals('test-document-forms', df[1].id);
  assertTrue(df.length >= 2);
  pass('test-document-forms');
});

jsunitRegister('testFormElements',
               function testFormElements() {
  var f = document.getElementById('test-form-elements');

  ////////////////////////////////////////////////////////////
  // Ensure that the form provides access to its elements by
  // direct property access based on the NAME of the enclosed
  // form element. This access is HTMLCollection-like, but not
  // the full HTMLCollection API (it does not include the
  // namedItem() method).

  // If there exist multiple elements with the same name, the
  // result of this access must be a DOM NodeList.

  assertEquals(3, f.a.length);
  assertEquals(3, f.b.length);
  assertEquals('INPUT', f.a[0].tagName);
  assertEquals('BUTTON', f.b[0].tagName);
  assertEquals('INPUT', f.a.item(0).tagName);
  assertEquals('BUTTON', f.b.item(0).tagName);

  // If there exists only one element with that name, the
  // result of this access must be that HTMLElement itself.
  assertEquals('INPUT', f.c.tagName);

  ////////////////////////////////////////////////////////////
  // Ensure that f.elements is a proper HTMLCollection.

  // Check numeric indexing
  assertEquals(7, f.elements.length);
  assertEquals('INPUT', f.elements[0].tagName);
  assertEquals('BUTTON', f.elements[3].tagName);
  assertEquals('INPUT', f.elements[6].tagName);
  assertEquals('INPUT', f.elements.item(0).tagName);
  assertEquals('BUTTON', f.elements.item(3).tagName);
  assertEquals('INPUT', f.elements.item(6).tagName);
  assertFalse(!!f.elements.item(7));

  // Check indexing by name.
  // If there exist multiple elements with the same name, the
  // result of this access must be a DOM NodeList.
  assertEquals(3, f.elements.a.length);
  assertEquals(3, f.elements.b.length);
  assertEquals('INPUT', f.elements.a[0].tagName);
  assertEquals('BUTTON', f.elements.b[0].tagName);
  assertEquals('INPUT', f.elements.a.item(0).tagName);
  assertEquals('BUTTON', f.elements.b.item(0).tagName);

  // Check indexing by name.
  // If there exists only one element with that name, the
  // result of this access must be that HTMLElement itself.
  assertEquals('INPUT', f.elements.c.tagName);

  // Check indexing by name.
  // Nonexistent names return falsy.
  assertFalse(!!f.elements.d);

  // Check indexing by name.
  // The namedItem() method will return only the *first*
  // element having the given name, and nonexistent names
  // return falsy.
  assertEquals('INPUT', f.elements.namedItem('a').tagName);
  assertEquals('BUTTON', f.elements.namedItem('b').tagName);
  assertEquals('INPUT', f.elements.namedItem('c').tagName);
  assertFalse(!!f.elements.namedItem('d'));

  pass('test-form-elements');
});

jsunitRegister('testOnclickHandler',
               function testOnclickHandler() {
  // nothing to do here
});

jsunitRegister('testCurrentTarget',
               function testCurrentTarget() {
  var parent = document.getElementById('test-current-target');
  var child = document.getElementById('test-current-target-child');
  var gotChildClick = false;

  var childClick = jsunitCallback(function (event) {
    assertEquals('test-current-target-child', event.currentTarget.id);
    gotChildClick = true;
  });

  var parentClick = jsunitCallback(function (event) {
    assertEquals('test-current-target', event.currentTarget.id);
    assertTrue(gotChildClick);
    pass('test-current-target');
  });

  parent.addEventListener('click', parentClick, false);
  child.addEventListener('click', childClick, false);
});

jsunitRegister('testRelatedTarget',
               function testRelatedTarget() {
  var childClick = jsunitCallback(function (event) {
    // get should work.  in manual clicks, relatedTarget is null, but in
    // webdriver simulated clicks, it's non-null.
    assertEquals(event.relatedTarget, event.relatedTarget);
    // set doesn't have to work, but shouldn't throw an error
    event.relatedTarget = [];
    pass('test-related-target');
  });

  var child = document.getElementById('test-related-target-child');
  child.addEventListener('click', childClick, false);

  // TODO: webdriver doesn't have a good way of testing relatedTarget.
  // there are two cases we care about: relatedTarget is an element in the
  // sandbox, and relatedTarget is an element outside the sandbox.

  var mouseReport = jsunitCallback(function (event) {
    var r = event.relatedTarget;
    r = r && (r.tagName + '#' + r.id);
    info.innerHTML = event.type + ' ' + String(r);
  });

  var mouse = document.getElementById('test-related-target-mouse');
  var info = document.getElementById('test-related-target-mouse-info');
  mouse.addEventListener('mouseover', mouseReport, false);
  mouse.addEventListener('mouseout', mouseReport, false);
});


jsunitRegister('testDocumentWrite',
               function testDocumentWrite() {
  // TODO(mikesamuel): This is wrong because we don't allow the insertion point
  // to move above it's starting position
  assertEquals(
      ''
      + '<div>'
        + '<p>Before <code>document.write</code></p>'
        + '<p id="test-document-write-foo">Document written</p>'
        + '<p>After <code>document.write</code></p>'
      + '</div>'
      + '<div>'
        + '<p>Written afterwards</p>'
        + '<p>More written afterwards</p>'
      + '</div>',
      document.getElementById('test-document-write').innerHTML
           .replace(new RegExp('[\\r\\n]\\s*', 'g'), ''));
  pass('test-document-write');
});

jsunitRegister('testAttrsDeclaredInMarkup',
               function testAttrsDeclaredInMarkup() {
  var d = document.getElementById('test-attrs-declared-in-markup').firstChild;

  assertTrue(d.hasAttribute('title'));
  assertEquals('test title', d.getAttribute('title'));
  d.setAttribute('title', 'another title');
  assertTrue(d.hasAttribute('title'));
  assertEquals('another title', d.getAttribute('title'));
  d.removeAttribute('title');
  assertFalse(d.hasAttribute('title'));
  assertEquals(null, d.getAttribute('title'));
  // Removing twice should be harmless
  d.removeAttribute('title');
  assertFalse(d.hasAttribute('title'));
  assertEquals(null, d.getAttribute('title'));

  pass('test-attrs-declared-in-markup');
});

jsunitRegister('testAttrsNotInMarkup',
               function testAttrsNotInMarkup() {
  var d = document.getElementById('test-attrs-not-in-markup').firstChild;

  assertFalse(d.hasAttribute('title'));
  assertEquals(null, d.getAttribute('title'));
  d.setAttribute('title', 'another title');
  assertTrue(d.hasAttribute('title'));
  assertEquals('another title', d.getAttribute('title'));
  d.removeAttribute('title');
  assertFalse(d.hasAttribute('title'));
  assertEquals(null, d.getAttribute('title'));

  // Removing twice should be harmless
  d.removeAttribute('title');
  assertFalse(d.hasAttribute('title'));
  assertEquals(null, d.getAttribute('title'));

  pass('test-attrs-not-in-markup');
});

jsunitRegister('testAttrsNonstandardPermitted',
               function testAttrsNonstandardPermitted() {
  var d =
      document.getElementById('test-attrs-nonstandard-permitted').firstChild;

  assertFalse(d.hasAttribute('flavor'));
  assertEquals(null, d.getAttribute('flavor'));
  d.setAttribute('flavor', 'chocolate');
  assertTrue(d.hasAttribute('flavor'));
  assertEquals('chocolate', d.getAttribute('flavor'));
  d.removeAttribute('flavor');
  assertFalse(d.hasAttribute('flavor'));
  assertEquals(null, d.getAttribute('flavor'));

  // Removing twice should be harmless
  d.removeAttribute('flavor');
  assertFalse(d.hasAttribute('flavor'));
  assertEquals(null, d.getAttribute('flavor'));

  // Should be case insensitive
  d.setAttribute('flavor', 'peach');
  assertEquals('peach', d.getAttribute('FLAvor'));

  pass('test-attrs-nonstandard-permitted');
});

// TODO(metaweta): This test should be replaced by ones for the proper
// behavior once we get property names into the HTML schema.
jsunitRegister('testPropertyAttributeInteraction',
               function testPropertyAttributeInteraction() {
  var d = document.getElementById('test-property-attribute-interaction-label');
  d.setAttribute('foo', 'hi');
  d.setAttribute('title', 'there');
  assertEquals(void 0, d.FOO);
  assertEquals(void 0, d.foo);
  assertEquals('hi', d.getAttribute('FOO'));
  assertEquals('hi', d.getAttribute('foo'));
  assertEquals('there', d.TITLE);
  assertEquals('there', d.title);
  assertEquals('there', d.getAttribute('title'));
  assertEquals('there', d.getAttribute('TITLE'));
  d.title = 'bob';
  assertEquals('bob', d.getAttribute('title'));
  pass('test-property-attribute-interaction');
});

jsunitRegister('testFormLength',
               function testFormLength() {
  var form = document.getElementById('test-form-length-form');
  assertEquals(2, form.length);

  pass('test-form-length');
});

jsunitRegister('testPseudoElements',
               function testPseudoElements() {
  var body = document.getElementsByTagName('body')[0];
  var head = document.getElementsByTagName('head')[0];
  var title = document.getElementsByTagName('title')[0];
  var html = document.getElementsByTagName('html')[0];

  assertEquals('BODY', body.getTagName());
  assertEquals(null, body.getAttribute('foo'));
  assertEquals('HEAD', head.getTagName());
  assertEquals(null, head.getAttribute('foo'));
  assertEquals('TITLE', title.getTagName());
  assertEquals(null, title.getAttribute('foo'));
  assertEquals('HTML', html.getTagName());
  assertEquals(null, html.getAttribute('foo'));

  pass('test-pseudo-elements');
});

jsunitRegister('testEditabilityInNodeLists',
               function testEditabilityInNodeLists() {
  var paragraph = document.getElementsByTagName('p')[0];
  // Make sure the node is editable.
  paragraph.foo = 1;
  assertEquals('1', String(paragraph.foo));
  delete paragraph.foo;
  assertEquals(undefined, paragraph.foo);

  paragraph = document.getElementsByClassName('testcontainer')[0];
  // Make sure the node is editable.
  paragraph.foo = 1;
  assertEquals('1', String(paragraph.foo));
  delete paragraph.foo;
  assertEquals(undefined, paragraph.foo);

  pass('test-editability-in-node-lists');
});

jsunitRegister('testNonexistentStyleProperty',
               function testNonexistentStyleProperty() {
  var container = document.getElementById(
      'test-nonexistent-style-property-label');
  assertEquals(undefined, container.style.noSuchProperty);
  pass('test-nonexistent-style-property');
});

jsunitRegister('testGetElementById',
               function testGetElementById() {
  assertEquals(null, document.getElementById('foo'));
  assertEquals(null, document.getElementById('bar'));
  assertEquals(null, document.getElementById('no_such_node'));
  assertTrue(document.getElementById('test-get-element-by-id') != null);

  pass('test-get-element-by-id');
});

jsunitRegister('testGetElementById2',
               function testGetElementById2() {
  assertEquals(null, document.getElementById('xyz-test-get-element-by-id'));
  assertTrue(document.getElementById('test-get-element-by-id-2') != null);

  pass('test-get-element-by-id-2');
});

jsunitRegister('testContains',
               function testContains() {
  // Some nodes that are not under the document element.
  var disconnectedEl = document.createElement('DIV');
  var disconnectedChild = document.createElement('B');
  var result = disconnectedEl.appendChild(disconnectedChild);
  assertEquals(result, disconnectedChild);

  var testContainer = document.getElementById('test-contains');
  var testContainerChild = document.createElement('SPAN');
  result = testContainer.appendChild(testContainerChild);
  assertEquals(result, testContainerChild);
  // This test assume that test-forms follows test-contains in the HTML above.
  var follower = document.getElementById('test-forms');

  var hasContains = 'contains' in testContainer;
  var hasCompare = 'compareDocumentPosition' in testContainer;
  assertTrue('neither contains nor compare present', hasContains || hasCompare);

  if (hasContains) {
    assertTrue('dEl > dCh', disconnectedEl.contains(disconnectedChild));
    assertFalse('dCh > dEl', disconnectedChild.contains(disconnectedEl));
    assertTrue('tCo > tCo', testContainer.contains(testContainer));
    assertFalse('tCo > fo', testContainer.contains(follower));
    assertFalse('fo > tCo', follower.contains(testContainer));
    assertTrue('tCo > tCh', testContainer.contains(testContainerChild));
    assertFalse('tCh > tCo', testContainerChild.contains(testContainer));
  }

  if (hasCompare) {
    var DOCUMENT_POSITION_DISCONNECTED = 0x01;
    var DOCUMENT_POSITION_PRECEDING = 0x02;
    var DOCUMENT_POSITION_FOLLOWING = 0x04;
    var DOCUMENT_POSITION_CONTAINS = 0x08;
    var DOCUMENT_POSITION_IS_CONTAINED = 0x10;

    assertEquals(
        'dEl cmp tCo',
        DOCUMENT_POSITION_DISCONNECTED,
        disconnectedEl.compareDocumentPosition(testContainer));
    assertEquals(
        'tCo cmp dEl',
        DOCUMENT_POSITION_DISCONNECTED,
        testContainer.compareDocumentPosition(disconnectedEl));
    assertEquals(
        'tCo cmp fo',
        DOCUMENT_POSITION_FOLLOWING,
        testContainer.compareDocumentPosition(follower));
    assertEquals(
        'fo cmp tCo',
        DOCUMENT_POSITION_PRECEDING,
        follower.compareDocumentPosition(testContainer));
    assertEquals(
        'tCp cmp tCh',
        DOCUMENT_POSITION_FOLLOWING | DOCUMENT_POSITION_IS_CONTAINED,
        testContainer.compareDocumentPosition(testContainerChild));
    assertEquals(
        'tCh cmp tCo',
        DOCUMENT_POSITION_PRECEDING | DOCUMENT_POSITION_CONTAINS,
        testContainerChild.compareDocumentPosition(testContainer));
    assertEquals(
        'tCo cmp tCo',
        0,
        testContainer.compareDocumentPosition(testContainer));
  }

  pass('test-contains');
});

jsunitRegister('testElementId',
               function testElementId() {
  var el = document.getElementById('test-element-id');
  assertEquals('test-element-id', el.id);
  assertEquals('test-element-id', el.getAttribute('id'));

  pass('test-element-id');
});

jsunitRegister('testCreateElement',
               function testCreateElement() {
  var newNode = document.createElement('DIV');
  assertEquals('', newNode.id);
  newNode.id = 'newNodeId';
  assertEquals('newNodeId', newNode.id);

  newNode.id = '#bog<us>';  // Not set
  assertEquals('newNodeId', newNode.id);

  newNode.id = 'not:bogus';
  assertEquals('not:bogus', newNode.id);
  assertEquals(1, newNode.nodeType);

  var el = document.getElementById('test-create-element');
  el.appendChild(newNode);

  assertEquals(document.getElementById('not:bogus').tagName,
               newNode.tagName);
  assertEquals(newNode.tagName, el.firstChild.tagName);
  assertEquals(newNode.tagName, el.lastChild.tagName);

  var text = document.createTextNode(
      { toString: function () { return 'howdy <there>'; } });
  assertEquals(3, text.nodeType);
  assertEquals('howdy <there>', text.data);
  newNode.appendChild(text);
  assertEquals(3, newNode.firstChild.nodeType);
  assertEquals('howdy &lt;there&gt;', canonInnerHtml(newNode.innerHTML));

  pass('test-create-element');
});

jsunitRegister('testInnerHtml',
               function testInnerHtml() {
  var container = document.getElementById('test-inner-html');

  // Strips out non-prefixed id from link, and target=_parent.
  // Leaves id for <em> but strips the prefix.
  // Escapes trailing title, href, and > after </em>.
  assertEquals(
      '<a class="link" href="http://foo.com?a&#61;b&amp;c&#61;d"'
      + ' title="&lt;click me!&gt;">'
      + 'Test <em id="em">Not</em>&gt; run yet.</a>',
      canonInnerHtml(container.innerHTML));

  // Set innerHTML
  container.innerHTML = (
      '<a  id="foo" class="green blue" href="http://bar.com/baz"'
      + ' target="foo" title="A link" >'
      + 'A & B &amp; C<</a >');

  assertEquals(
      '<a class="green blue" href="http://gadget-proxy/'
      + '?url=http%3A%2F%2Fbar.com%2Fbaz&amp;mimeType=*%2F*" id="foo-xyz___"'
      + ' target="_blank" title="A link">A &amp; B &amp; C&lt;</a>',
      canonInnerHtml(directAccess.getInnerHTML(container)));
      
  var span = document.createElement('SPAN');
  container.appendChild(span);
  // See Issue 714 for the derivation of these tests.
  var inputsAndGoldens = [
      [null, ''],
      [undefined, 'undefined'],
      [4, '4'],
      [{}, '[object Object]'],
      ['my_string', 'my_string']];
  for (var i = 0; i < inputsAndGoldens.length; ++i) {
    var pair = inputsAndGoldens[i];
    span.innerHTML = pair[0];
    assertEquals(pair[1], span.innerHTML);
  }

  pass('test-inner-html');
});

var foo = jsunitCallback(
    function foocb() {
      var container = document.getElementById('test-forms');
      var div = document.createElement('blockquote');
      div.innerHTML = 'event dispatched to <code>foo()</code>';
      container.appendChild(div);
    },
    'testForms');

jsunitRegister('testForms',
               function testForms() {
  var form = document.createElement('FORM');
  assertEquals('return false', directAccess.getAttribute(form, 'onsubmit'));

  var container = document.getElementById('test-forms');
  container.innerHTML = '<form onsubmit="foo()">'
      + '<input type="submit" value="Submit"></form>';

  assertEquals('<form onsubmit="'
               + 'try { plugin_dispatchEvent___'
               + '(this, event, 0, &quot;foo&quot;);'
               + ' } finally { return false; }">'
               + '<input type="submit" value="Submit"></form>',
               canonInnerHtml(directAccess.getInnerHTML(container)));

  pass('test-forms');
});

// TODO: this test often causes ie6/ie7 to crash.  figure out why
if (false)
jsunitRegister('testScriptLoading',
               function testScriptLoading() {
  // Test that we block ways scripts can be used to executed code in strings.
  expectFailure(
      function () {
        var s = document.createElement('script');
        s.appendChild(document.createTextNode('globalSideEffect()'));
      }, 'script injection via appendChild');
  assertFalse('gse1', checkGlobalSideEffect());
  expectFailure(
      function () {
        var s = document.createElement('script');
        s.innerHTML = 'globalSideEffect()';
      }, 'script injection via innerHTML');
  assertFalse('gse2', checkGlobalSideEffect());
  expectFailure(
      function () {
        var s = directAccess.makeUnattachedScriptNode();
        s.firstChild.nodeValue = 'globalSideEffect()';
      }, 'script injection via nodeValue');
  assertFalse('gse3', checkGlobalSideEffect());
  expectFailure(
      function () {
        var os = document.getElementById('howdy-script');
        var s = os.cloneNode(true);
        s.firstChild.nodeValue = 'globalSideEffect()';
      }, 'script injection via cloneNode');
  assertFalse('gse4', checkGlobalSideEffect());
  assertFailsSafe(
      function () {
        var s = document.createElement('script');
        s.innerText = 'globalSideEffect()';  // IE only, so failsafe.
        document.body.appendChild(s);
      },
      function () {});
  assertFalse('gse5', checkGlobalSideEffect());
  assertFailsSafe(
      function () {
        var s = document.createElement('script');
        // IE only, so failsafe.
        s.outerHTML = '<script>globalSideEffect()<\/script>';
        document.body.appendChild(s);
      },
      function () {});
  assertFalse('gse6', checkGlobalSideEffect());
  assertFailsSafe(
      function () {
        var s = document.createElement('div');
        // IE only, so failsafe.
        s.outerHTML = '<script>globalSideEffect()<\/script>';
        document.body.appendChild(s);
      },
      function () {});
  assertFalse('gse7', checkGlobalSideEffect());

  // Test that an external script cannot be loaded by setting the "src"
  // attribute of a newly created script element.
  var s = document.createElement('script');
  assertAsynchronousRequirement(
      'whitelisted script never ran',
      jsunitCallback(function () { return externalScript.loaded === true; }));
  s.src = 'unproxied_whitelisted_script.js';
  document.getElementById('test-script-loading').appendChild(s);

  pass('test-script-loading');
});

jsunitRegister('testGetElementsByTagName',
               function testGetElementsByTagName() {
  var container = document.getElementById('test-get-elements-by-tag-name');
  var items = container.getElementsByTagName('li');
  assertEquals(5, items.length);
  for (var i = 0; i < items.length; ++i) {
    assertEquals('LI', items[i].tagName);
  }
  assertEquals('One', canonInnerHtml(items[0].innerHTML));
  assertEquals('Two', canonInnerHtml(items[1].innerHTML));
  assertEquals('Three', canonInnerHtml(items[2].firstChild.data));
  assertEquals('Pi', canonInnerHtml(items[3].innerHTML));
  assertEquals('sqrt(10)', canonInnerHtml(items[4].innerHTML));
  pass('test-get-elements-by-tag-name');
});

jsunitRegister('testGetElementsByClassName',
               function testGetElementsByTagName() {
  function assertNodeListTextContent(classes, textContent) {
    var nodeList = document.getElementsByClassName(classes);
    var len = nodeList.length;
    assertEquals(textContent.length, len);
    for (var i = 0; i < len; ++i) {
      assertEquals(textContent[i], canonInnerHtml(nodeList[i].innerHTML));
    }
  }

  assertNodeListTextContent('aaa', ['AAA BBB', 'AAA']);
  assertNodeListTextContent('ccc bbb', ['BBB CCC']);
  assertNodeListTextContent('bbb ccc', ['BBB CCC']);
  assertNodeListTextContent(' bbb \tccc ', ['BBB CCC']);
  assertNodeListTextContent('aaa,bbb', []);

  pass('test-get-elements-by-class-name');
});

jsunitRegister('testClassSetByEmitter',
               function testClassSetByEmitter() {
  // Make sure that the HTML emitter correctly sets the class.
  // A testcontainer node should be yellow until it has been marked as having
  // passed.
  var cont = document.getElementById('test-class-set-by-emitter');
  var computedColor = directAccess.getComputedStyle(cont, 'background-color');

  cont.innerHTML = '(background-color=' + computedColor + ')';

  assertColor({ name: 'yellow', rgb: 0xffff00 }, computedColor);
  pass('test-class-set-by-emitter');
});

jsunitRegister('testDynamicStyle',
               function testDynamicStyle() {
  function $(id) { return document.getElementById(id); }
  $('test-dynamic-styles1').style.fontWeight = 'bold';
  $('test-dynamic-styles2').style.fontWeight = '';  // Can unset a style.
  expectFailure(
      function () {
        $('test-dynamic-styles3').style.fontWeight = 'super-bold';
      },
      'set to super-bold');
  pass('test-dynamic-styles');
});

jsunitRegister('testSpecialStyleNames',
               function testSpecialStyleNames() {
  function getFloatySpanFloat() {
    return directAccess.getComputedStyle(floatySpan, 'float')
        || directAccess.getComputedStyle(floatySpan, 'cssFloat')
        || directAccess.getComputedStyle(floatySpan, 'styleFloat');
  }

  // Some style names conflict with reserved keywords in many languages,
  // e.g. float.
  var floatySpan = document.getElementById('test-special-style-names')
      .getElementsByTagName('SPAN')[0];
  assertEquals('none', getFloatySpanFloat());
  assertEquals('left', (floatySpan.style.cssFloat = 'left'));
  assertEquals('left', floatySpan.style.cssFloat);
  assertEquals('left', getFloatySpanFloat());
  assertEquals('left', floatySpan.style.getPropertyValue('float'));
  try {
    floatySpan.style.styleFloat = 'right';
    console.log('styleFloat supported');
  } catch (styleFloatWorksOnIE) {
    floatySpan.style.cssFloat = 'right';
  }
  assertEquals('right', getFloatySpanFloat());
  assertEquals('right', floatySpan.style.cssFloat);
  assertEquals('right', floatySpan.style.getPropertyValue('float'));

  pass('test-special-style-names');
});

jsunitRegister('testReadOnlyNotEditable',
               function testReadOnlyNotEditable() {
  function $(id) { return documentRO.getElementById(id); }
  expectFailure(
      function () {
        documentRO.createElement('SPAN');
      },
      'successfully created element');
  expectFailure(
      function () {
        var el = document.createElement('SPAN');
        el.id = 'test-read-only-1';
        $('test-read-only').appendChild(el);
        assertEquals(null, $('test-read-only-1'));
      },
      'successfully appended element');
  expectFailure(
      function () {
        assertTrue($('indelible') !== null);
        $('test-read-only').removeChild($('indelible'));
        assertEquals(null, $('test-read-only-1'));
      },
      'successfully removed element');
  expectFailure(
      function () {
        var el = document.createElement('SPAN');
        el.id = 'test-read-only-2';
        $('test-read-only').replaceChild($('indelible'), el);
        assertEquals(null, $('test-read-only-2'));
        assertTrue($('indelible') !== null);
      },
      'successfully replaced element');
  pass('test-read-only');
});

jsunitRegister('testRemoveChild',
               function testRemoveChild() {
  var parent = document.getElementById('test-remove-child');
  var child = document.getElementById('test-remove-child-1');
  var result = parent.removeChild(child);
  assertEquals(child, result);
  assertEquals('hello', canonInnerHtml(parent.innerHTML));
  pass('test-remove-child');
});

jsunitRegister('testReplaceChild',
               function testReplaceChild() {
  var parent = document.getElementById('test-replace-child');
  var newChild = document.getElementById('test-replace-child-1');
  var oldChild = document.getElementById('test-replace-child-2');
  var result = parent.replaceChild(newChild, oldChild);
  assertEquals(oldChild, result);
  assertEquals(
      'bravo<span id="test-replace-child-1">alpha</span>',
      canonInnerHtml(parent.innerHTML));
  pass('test-replace-child');
});

jsunitRegister('testInsertBefore',
               function testInsertBefore() {
  var el = document.getElementById('test-insert-before');
  function assertChildren(var_args) {
    var children = [];
    for (var child = el.firstChild; child; child = child.nextSibling) {
      children.push(child.nodeValue);
    }
    assertEquals([].join.call(arguments, ','), children.join(','));
  }
  var one = document.createTextNode('one');
  var two = document.createTextNode('two');
  var three = document.createTextNode('three');
  var four = document.createTextNode('four');
  var result = el.insertBefore(three, null);
  assertEquals(three, result);
  assertChildren('zero', 'three');
  el.insertBefore(one, three);
  assertChildren('zero', 'one', 'three');
  el.insertBefore(two, null);
  assertChildren('zero', 'one', 'three', 'two');
  el.insertBefore(four, two);
  assertChildren('zero', 'one', 'three', 'four', 'two');
  el.insertBefore(two, one);
  assertChildren('zero', 'two', 'one', 'three', 'four');
  el.insertBefore(one, two);
  assertChildren('zero', 'one', 'two', 'three', 'four');
  el.insertBefore(four, void 0);
  assertChildren('zero', 'one', 'two', 'three', 'four');
  pass('test-insert-before');
});

jsunitRegister('testNodeLists',
               function testNodeLists() {
  function $(id) { return document.getElementById(id); }
  var descendants = $('test-node-lists').getElementsByTagName('*');
  assertEquals(4, descendants.length);

  assertEquals('LI', descendants[0].tagName);
  assertEquals('LI', descendants[1].tagName);
  assertEquals('B', descendants[2].tagName);
  assertEquals('LI', descendants[3].tagName);

  assertEquals('LI', descendants.item(0).tagName);
  assertEquals('LI', descendants.item(1).tagName);
  assertEquals('B', descendants.item(2).tagName);
  assertEquals('LI', descendants.item(3).tagName);

  var item = descendants.item;
  // Check does not access properties of global.
  assertEquals('LI', item(0).tagName);

  // TODO(mikesamuel): test that getElementsByTagName and getElementsByClassName
  // do not return the body.

  pass('test-node-lists');
});

jsunitRegister('testNameAttr',
               function testNameAttr() {
  var testDiv = document.getElementById('test-name-attr');
  testDiv.innerHTML = '<span name="test-span">text</span>';
  var nameAttr = directAccess.getAttribute(testDiv.firstChild, 'name');
  assertFalse('test-span' === nameAttr); // Should have been renamed
  pass('test-name-attr');
});

jsunitRegister('testTargetAttr',
               function testTargetAttr() {
  var testDiv = document.getElementById('test-target-attr');
  testDiv.innerHTML = '<a target="foo">text1</a><a>text2</a>';
  var node = testDiv.firstChild;
  assertEquals('_blank', directAccess.getAttribute(node, 'target'));
  node = node.nextSibling;
  assertEquals('_blank', directAccess.getAttribute(node, 'target'));
  pass('test-target-attr');
});

jsunitRegister('testLocation',
               function testLocation() {
  assertEquals(
      window.location.host,
      window.location.hostname + ':' + window.location.port);
  assertEquals(
      window.location.href,
      window.location.protocol + '//' + window.location.hostname
      + ':' + window.location.port + window.location.pathname
      + window.location.search + window.location.hash);
  assertEquals(
      'http://zip.example.com:4242/pumpkin.html?q=getit#myanchor',
      window.location.href);
  assertEquals(
      '#myanchor',
      window.location.hash);
  assertEquals(
      'zip.example.com:4242',
      window.location.host);
  assertEquals(
      'zip.example.com',
      window.location.hostname);
  assertEquals(
      '/pumpkin.html',
      window.location.pathname);
  assertEquals(
      '4242',
      window.location.port);
  assertEquals(
      'http:',
      window.location.protocol);
  assertEquals(
      '?q=getit',
      window.location.search);
  assertEquals(
      window.location.hostname,
      document.domain);
  pass('test-location');
});

jsunitRegister('testNavigator',
               function testNavigator() {
  assertNotNull(window.navigator.userAgent);
  pass('test-navigator');
});

jsunitRegister('testOpaqueNodes',
               function testOpaqueNodes() {
  var noText = document.createTextNode('');
  // See bug 589.  We need to keep unsafe nodes in the DOM so that DOM
  // navigation works, but we can't allow inspection or editing of such nodes.
  var container = document.getElementById('test-opaque-nodes');

  var child = container.firstChild;
  assertEquals(8, child.nodeType);
  assertEquals('#comment', child.nodeName);
  assertEquals(' Comment ', child.nodeValue);

  child = child.nextSibling;
  assertEquals(3, child.nodeType);
  assertEquals('#text', child.nodeName);
  assertEquals('a', child.nodeValue);
  child.nodeValue = 'Foo';
  assertEquals('Foo', child.nodeValue);

  child = child.nextSibling;
  assertEquals(1, child.nodeType);
  assertEquals('SCRIPT', child.nodeName);
  assertEquals(null, child.nodeValue);
  expectFailure(function () { child.appendChild(noText); },
                'script node was editable');

  child = child.nextSibling;
  assertEquals(3, child.nodeType);
  assertEquals('#text', child.nodeName);
  assertEquals('b', child.nodeValue);
  child.nodeValue = 'Foo';
  assertEquals('Foo', child.nodeValue);

  child = child.nextSibling;
  assertEquals(1, child.nodeType);
  assertEquals('OBJECT', child.nodeName);
  assertEquals(null, child.nodeValue);
  expectFailure(function () { child.appendChild(noText); },
                'object node was editable');

  child = child.nextSibling;
  assertEquals(3, child.nodeType);
  assertEquals('#text', child.nodeName);
  assertEquals('c', child.nodeValue);
  child.nodeValue = 'Foo';
  assertEquals('Foo', child.nodeValue);

  pass('test-opaque-nodes');
});

jsunitRegister('testChildNodes',
               function testChildNodes() {
  var container = document.getElementById('test-child-nodes');
  container.innerHTML = '<b>foo</b> <i>bar</i> <u>baz</u>';
  var childNodes = container.childNodes;
  assertEquals(5, childNodes.length);
  assertEquals('B', childNodes[0].nodeName);
  assertEquals('#text', childNodes[1].nodeName);
  assertEquals('I', childNodes[2].nodeName);
  assertEquals('#text', childNodes[3].nodeName);
  assertEquals('U', childNodes[4].nodeName);
  pass('test-child-nodes');
});

jsunitRegister('testEmitCss',
               function testCss() {
  directAccess.emitCssHook(['.', ' a#not-blue-', ' { color: #00ff00 }']);
  var computedColor = directAccess.getComputedStyle(
      document.getElementById('not-blue'), 'color');
  assertColor({ rgb: 0x00ff00, name: 'green' }, computedColor);
  pass('test-emit-css');
});

jsunitRegister('testBug731',
               function testBug731() {
  // Tests that attributes set before node added to DOM so that side-effects
  // such as network requests happen all at once.  This is especially important
  // on IE.

  var bug_731_input = document.getElementById('bug-731');
  assertEquals('radio', bug_731_input.type);
  pass('test-bug-731');
});

jsunitRegister('testBug920',
               function testBug920() {
  var bug_920_input = document.getElementById('bug-920');
  assertEquals('text', bug_920_input.type);
  pass('test-bug-920');
});

jsunitRegister('testArraySlice',
               function testArraySlice() {
  function assertArray(expect, actual, note) {
    assertEquals(note + ' typeof', 'object', typeof actual);
    assertEquals(note + ' length', expect.length, actual.length);
    for (var k = 0; k < actual.length; ++k) {
      assertEquals(note + ' @' + k, expect[k], actual[k]);
    }
  }

  assertArray([], Array.slice(null), 'null');
  assertArray([], Array.slice(void 0), 'void 0');

  // note difference between missing arg and undefined arg.
  assertArray([9], Array.slice([9]), '([9])');
  assertArray([9], Array.slice([9], void 0), '([9], void 0)');
  assertArray([],  Array.slice([9], void 0, void 0), '([9], void 0, void 0)');
  assertArray([],  Array.slice([9], void 0, 0), '([9], void 0, 0)');

  assertArray([2,3,4], Array.slice([0,1,2,3,4,5,6], 2, 5));
  assertArray([2,3], Array.slice([0,1,2,3], 2, 5));

  pass('test-array-slice');
});

// http://code.google.com/p/google-caja/issues/detail?id=1077
jsunitRegister('testBrowserApply',
               function testBrowserApply() {
  var count = 0;

  var inc = function() { if (arguments.length === 0) count += 1; };

  inc.apply({});
  inc.apply({}, []);
  assertEquals('inc()', 2, count);

  inc.apply({}, [1]);
  assertEquals('inc(1)', 2, count);

  // ES5 says these should work, but they throw an error on IE[678] in
  // cajita, but not in valija.  In cajita, these become a direct call to
  // native apply, and native apply throws the error.  This could be fixed
  // by wrapping apply, but that adds overhead without much benefit.
  //inc.apply({}, null);
  //inc.apply({}, undefined);

  // ES5 says these should throw TypeError.  They usually do in cajita, and
  // usually don't in valija.  Enforcing the TypeError adds overhead
  // without much benefit.
  //expectFailure(function() { inc.apply({}, 0); }, 'apply 0');
  //expectFailure(function() { inc.apply({}, 1); }, 'apply 1');
  //expectFailure(function() { inc.apply({}, false); }, 'apply false');
  //expectFailure(function() { inc.apply({}, true); }, 'apply true');
  //expectFailure(function() { inc.apply({}, ''); }, 'apply ""');
  //expectFailure(function() { inc.apply({}, 'x'); }, 'apply "x"');
  //expectFailure(function() { inc.apply({}, {length:0}); }, 'fake array"');

  var add = function(x) { if (arguments.length === 1) count += x; };

  add.apply({}, [3]);
  assertEquals('add(3)', 5, count);

  add.apply({}, []);
  add.apply({}, [4, 5]);
  assertEquals('add(4, 5)', 5, count);

  pass('test-browser-apply');
});

jsunitRegister('textXo4aApply',
               function testXo4aApply() {
  // cajita can't access Object.prototype
  if (directAccess.isValija) {
    var type = Object.prototype.toString.apply('');
    assertEquals('[object String]', type);
  }
  pass('test-xo4a-apply');
});

jsunitRegister('testInputDefaultValue',
               function testInputDefaultValue() {
  var form = document.getElementById('test-input-default-values');
  var text1 = form.elements[0];
  var text2 = form.elements[1];
  var check1 = form.elements[2];
  var check2 = form.elements[3];

  assertEquals('one', text1.value);
  assertEquals('two', text2.value);
  assertTrue(check1.checked);
  assertFalse(check2.checked);

  text1.value = 'First';
  text2.value = 'Second';
  check1.checked = false;
  check2.checked = true;

  assertEquals('First', text1.value);
  assertEquals('Second', text2.value);
  assertFalse(check1.checked);
  assertTrue(check2.checked);

  form.reset();

  assertEquals('one', text1.value);
  assertEquals('two', text2.value);
  assertTrue(check1.checked);
  assertFalse(check2.checked);

  pass('test-input-default-values');
});

var autoclicky = {
  clicked: [false, false],
  click: jsunitCallback(
      function autoclickyClick(i) {
        console.log('clicking');
        autoclicky.clicked[i] = true;
      },
      "testEventHandlerAttributes")
};

if (!directAccess.isValija) {
  $v.so('autoclicky', autoclicky);
}

jsunitRegister('testEventHandlerAttributes',
               function testEventHandlerAttributes() {
  assertFalse('initially unclicked', autoclicky.clicked[0]);
  directAccess.click(document.getElementById('autoclicker'));
  assertTrue('zero clicked', autoclicky.clicked[0]);
  var setOnclickOnMe = document.getElementById('set-onclick-on-me');
  assertFalse('one not clicked', autoclicky.clicked[1]);
  directAccess.click(setOnclickOnMe);
  assertFalse('one still not clicked', autoclicky.clicked[1]);
  setOnclickOnMe.onclick = jsunitCallback(
      function autoclickyClick() {
        autoclicky.click(1);
      });
  directAccess.click(setOnclickOnMe);
  assertTrue('one clicked', autoclicky.clicked[1]);

  pass('test-event-handler-attributes');
});

jsunitRegister('testEventListenersOnDocument',
               function testEventListenersOnDocument() {
  var clickCounter = 0;
  var clickHandler = jsunitCallback(
      function clickHandlerCb() {
        ++clickCounter;
      });

  var inp = document.getElementById('test-event-listeners-on-document')
      .getElementsByTagName('INPUT')[0];

  assertEquals('initially unclicked', 0, clickCounter);
  directAccess.click(inp);
  assertEquals('clicked before handler added', 0, clickCounter);
  document.addEventListener('click', clickHandler);
  directAccess.click(inp);
  assertEquals('clicked after handler added', 1, clickCounter);
  document.removeEventListener('click', clickHandler);
  assertEquals('clicked after handler removed', 1, clickCounter);

  pass('test-event-listeners-on-document');
});

jsunitRegister('testOnLoadListener',
               function testOnLoadListener() {
  var b1 = false;
  var b2 = false;
  var b3 = false;
  var setb1 = jsunitCallback(
      function setb1cb() {
        console.log('set onload b1');
        b1 = true;
      });
  var setb2 = jsunitCallback(
      function setb2cb() {
        console.log('set onload b2');
        b2 = true;
      });
   var setb3 = jsunitCallback(
       function setb3cb() {
         console.log('set onload b3');
         b3 = true;
       });

  window.addEventListener('load', setb1);
  window.addEventListener('load', setb2);
  window.removeEventListener('load', setb1);
  window.onload = setb3;
  //TODO(felix8a): also need to test when onload isn't set

  assertAsynchronousRequirement(
      'onload listeners',
      jsunitCallback(
          function checkb1b2b3cb() {
            if (!b1 && b2 && b3) {
              pass('test-onload-listener');
              return true;
            }
            return false;
          }));

  assertFalse(b1);
  assertFalse(b2);
  assertFalse(b3);
});

jsunitRegister('testInnerHTMLStyleSanitizer',
               function testInnerHTMLStyleSanitizer() {
  function colorOf(id) {
    return directAccess.getComputedStyle(document.getElementById(id), 'color');
  }
  function backgroundOf(id) {
    return directAccess.getComputedStyle(
        document.getElementById(id), 'background-color');
  }

  var cont = document.getElementById('test-inner-HTML-style-sanitizer');

  cont.innerHTML = '<span style="color: #00f" id="style-html">Blue</span>';
  assertColor({ name: 'blue', rgb: 0x0000ff }, colorOf('style-html'));

  cont.innerHTML = (
      '<span style="color: red; background-color: purple"'
      + ' id="style-html">Red on purple</span>');
  assertColor({ name: 'red', rgb: 0xff0000 }, colorOf('style-html'));
  assertColor({ name: 'purple', rgb: 0x800080 }, backgroundOf('style-html'));

  pass('test-inner-HTML-style-sanitizer');
});

jsunitRegister('testOffsetParent',
               function testOffsetParent() {
  var outer = document.getElementById('test-offset-parent');
  var inner = document.getElementById('test-offset-parent-inner');
  assertEquals("wrong inner.offsetParent: " + inner.offsetParent,
               outer, inner.offsetParent);
  assertEquals("wrong outer.offsetParent: " + outer.offsetParent,
               document.body, outer.offsetParent);
  assertEquals("wront body.offsetParent: " + document.body.offsetParent,
               undefined, document.body.offsetParent);
  pass('test-offset-parent');
});

function assertWithin(msg, golden, actual, tolerance) {
  if (!(Math.abs(golden - actual) <= tolerance)) {
    assertEquals(msg, golden, actual);
  }
}

jsunitRegister('testWhitespaceNodes1',
               function testWhitespaceNodes1() {
  var outerDiv = document.getElementById('whitespace-outer');
  var textOnlyP = document.getElementById('text-only');
  assertWithin('outer DIV width', 156, outerDiv.offsetWidth, 2);
  //
  // +---------+ outer top border
  // |         | outer top padding
  // |         | inner1 top margin
  // | +-----+ | inner1 top border
  // | |     | | inner1 top padding
  // | | hi  | | textOnly height
  // | |     | | inner1 bottom padding
  // | +-----+ | inner1 bottom border
  // |         | ceiling(inner1 bottom margin, inner2 top margin)
  // | +-----+ | inner2 top border
  // | |     | | inner2 top padding
  // | | hi  | | textOnly height
  // | |     | | inner2 bottom padding
  // | +-----+ | inner2 bottom border
  // |         | inner2 bottom margin
  // |         | outer bottom padding
  // +---------+ outer bottom border

  assertWithin('outer DIV height',
               2 * textOnlyP.offsetHeight
               + 2 * 4  // inner padding
               + 30     // inner margin, top/middle/bottom
               + 2 * 2  // inner borders
               + 4      // outer padding
               + 2,     // outer border -- may be skipped
               3,       // slop for outer border & rounding
               outerDiv.offsetHeight);
  pass('test-whitespace-nodes-1');
});

jsunitRegister('testWhitespaceNodes2',
               function testWhitespaceNodes1() {
  var cont = document.getElementById('test-whitespace-nodes-2');

  var node1 = document.getElementById('twn2-0');
  var node2 = document.getElementById('twn2-1');

  // These two nodes should be immediately adjacent vertically.
  assertWithin(
      'stacked paragraphs', node2.offsetHeight * 2, cont.offsetHeight, 4);

  pass('test-whitespace-nodes-2');
});

jsunitRegister('testRadioButtons',
               function testRadioButtons() {
  var form = document.getElementById('test-radio-buttons');
  var radio0 = form.elements[0],
      radio1 = form.elements[1],
      radio2 = form.elements[2];

  assertTrue('radio0 should be checked initially', radio0.checked);
  assertFalse('radio1 should not be checked initially', radio1.checked);
  assertFalse('radio2 should not be checked initially', radio2.checked);

  radio1.checked = true;

  assertFalse('radio0 should not be checked after 1 checked', radio0.checked);
  assertTrue('radio1 should be checked after 1 checked', radio1.checked);
  assertFalse('radio2 should not be checked after 1 checked', radio2.checked);

  radio2.checked = true;

  assertFalse('radio0 should not be checked after 2 checked', radio0.checked);
  assertFalse('radio1 should not be checked after 2 checked', radio1.checked);
  assertTrue('radio2 should be checked after 2 checked', radio2.checked);

  form.reset();

  assertTrue('radio0 should be checked after reset', radio0.checked);
  assertFalse('radio1 should not be checked after reset', radio1.checked);
  assertFalse('radio2 should not be checked after reset', radio2.checked);

  pass('test-radio-buttons');
});

jsunitRegister('testPropsOnNodes',
               function testPropsOnNodes() {
  var div = document.getElementById("test-props-on-nodes");
  var str = "";
  var i;

  div.newProp = 1;
  cajita.forAllKeys(div, function (i){ str += i + ": " + div[i] + "<br>"; });
  assertTrue("newProp should be among the enumerated properties",
             (new RegExp('\\bnewProp: 1\\b')).test(str));
  div.innerHTML = str;
  assertNotEquals("innerHTML should not be treated as an attribute",
                  str, div.getAttribute("innerHTML"));
  pass('test-props-on-nodes');
});

jsunitRegister('testXhrSync',
               function testXhrSync() {
  var xhr;

  // Check that response text is available after a synchronous XHR
  xhr = new window.XMLHttpRequest();
  xhr.open('GET', './xhrTest.txt', false);
  console.log('About to do sync xhr.send() - may get preempted');
  xhr.send();
  assertEquals('The quick brown fox', xhr.responseText);

  // Check that a synchronous XHR invokes its callback in ready state 4
  var responseText;
  xhr = new window.XMLHttpRequest();
  // Note we specify test id since we get preempted by xhr.send()
  xhr.onreadystatechange = jsunitCallback(
      function onreadystatechangecb() {
        if (xhr.readyState == 4) { responseText = xhr.responseText; }
      },
      'testXhrSync');
  xhr.open('GET', './xhrTest.txt', false);
  console.log('About to do sync xhr.send() - may get preempted');
  xhr.send();
  assertEquals('The quick brown fox', responseText);

  pass('test-xhr-sync');
});

jsunitRegister('testXhrAsync',
               function testXhrAsync() {
  var cont = document.getElementById('test-xhr-async');
  var xhr = new window.XMLHttpRequest();
  xhr.open('GET', './xhrTest.txt', true);
  var asyncFlag = 'PRE';
  xhr.onreadystatechange = jsunitCallback(function(event) {
    assertEquals(xhr, event.target);
    if (event.target.readyState === 4) {
      assertNotEquals(4, asyncFlag);
      asyncFlag = 'DONE';
      assertEquals('The quick brown fox', event.target.responseText);
      pass('test-xhr-async');
    }
    asyncFlag = event.target.readyState;
  });
  xhr.send();
});

jsunitRegister('testComputedStyle',
               function testComputedStyle() {
  function strip(value) {
    return value.replace(new RegExp(' ', 'g'), '');
  }
  function assertComputedStyle(element, pseudoElt, styleName, styleValue) {
    var msg = element.tagName + (element.id && '#' + element.id)
        + (pseudoElt ? ':' + pseudoElt : '')
        + ' { ' + styleName + ': ' + styleValue + ' }';
    var winStyle = window.getComputedStyle(element, pseudoElt),
        viewStyle = document.defaultView.getComputedStyle(element, pseudoElt);
    var propertyName = styleName.replace(
         new RegExp('([a-z])([A-Z])', 'g'),
         function (_, lc, uc) { return lc + '-' + uc.toLowerCase(); });
    assertEquals(msg, styleValue, strip(winStyle[styleName]));
    assertEquals(msg, styleValue || '',
                 strip(winStyle.getPropertyValue(propertyName)));
    assertEquals(msg, styleValue, strip(viewStyle[styleName]));
    assertEquals(msg, styleValue || '',
                 strip(viewStyle.getPropertyValue(propertyName)));
  }

  var block = document.getElementById('test-computed-style-block');
  var inline = document.getElementById('test-computed-style-inline');
  var fakie = document.getElementById('test-computed-style-fakie');
  var invisible = document.getElementById('test-computed-style-invisible');
  assertComputedStyle(block, null, 'display', 'block');
  assertComputedStyle(inline, null, 'display', 'inline');
  assertComputedStyle(fakie, null, 'display', 'inline');
  var NO_RESULT = {};
  var pseudoElementsSupported = false;
  try {
    var unused = window.getComputedStyle(fakie, 'first-line').display;
    pseudoElementsSupported = true;
  } catch (ex) {
    // Not supported on all browsers
  }
  if (pseudoElementsSupported) {
    assertComputedStyle(fakie, 'first-line', 'display', 'inline');
  }
  assertComputedStyle(invisible, null, 'display', 'none');
  assertComputedStyle(invisible, null, 'float', 'left');
  assertComputedStyle(block, null, 'color', 'rgb(3,6,9)');
  assertComputedStyle(block, null, 'float', 'none');

  pass('test-computed-style');
});

jsunitRegister('testSetStyle', function testSetStyle() {
  function cursor(el) {
    return directAccess.getComputedStyle(el, 'cursor');
  }

  var el = document.getElementById('test-set-style');
  assertEquals('move', cursor(el));

  el.style = 'cursor:wait';
  assertEquals('wait', cursor(el));

  var value = el.getAttribute('style');
  assertTrue(new RegExp('wait').test(value));

  el.setAttribute('style', 'cursor:help');
  assertEquals('help', cursor(el));

  pass('test-set-style');
});

jsunitRegister('testClassNames', function testClassNames() {

  function assertClassIs(className, el, note) {
    note = note || className;
    assertEquals(note + ' className', className, el.className);
    assertEquals(note + ' getAttribute', className, el.getAttribute('class'));
    assertTrue(note + ' hasAttribute', el.hasAttribute('class'));
  }

  var el = document.getElementById('test-class-names');
  assertEquals('before class added',
               'block', window.getComputedStyle(el, null).display);

  el.className += ' inline';

  assertEquals('after class added',
      'inline', window.getComputedStyle(el, null).display);
  assertClassIs('testcontainer inline', el);

  el.className = '$-.:;()[]=';
  assertClassIs('$-.:;()[]=', el);

  el.className = '!@{} ok__1';
  assertClassIs('!@{} ok__1', el);

  el.setAttribute('class', 'foo');
  assertClassIs('foo', el);

  el.className = 'simple';
  assertClassIs('simple', el);

  el.className = 'ok bad__';
  assertClassIs('simple', el, 'set class "ok bad__"');

  el.className = 'ok bad__ ';
  assertClassIs('simple', el, 'set class "ok bad__ "');

  el.className = 'bad__ ok';
  assertClassIs('simple', el, 'set class "bad__ ok"');

  el.setAttribute('class', 'bad__ ok2');
  assertClassIs('simple', el, 'set class "bad__ ok2"');

  el.className = '';
  assertClassIs('', el, 'set className ""');

  el.className = 'x';
  assertClassIs('x', el);

  el.setAttribute('class', '');
  assertClassIs('', el, 'setAttribute class ""');

  pass('test-class-names');
});

jsunitRegister('testIllegalSuffixes', function testIllegalSuffixes() {
  var el = document.getElementById('test-illegal-suffixes');

  el.innerHTML = '<input id="bad1__" name="bad2__">';
  assertFalse('id="bad1__"', !!el.firstChild.getAttribute('id'));
  assertFalse('name="bad2__"', !!el.firstChild.getAttribute('name'));

  el.innerHTML = '<input id="bad1__ " name="bad2__ ">';
  assertFalse('id="bad1__ "', !!el.firstChild.getAttribute('id'));
  assertFalse('name="bad2__ "', !!el.firstChild.getAttribute('name'));

  el.innerHTML = '<input id="b__ c" name="d__ e">';
  assertFalse('id="b__ c"', !!el.firstChild.getAttribute('id'));
  assertFalse('name="d__ e"', !!el.firstChild.getAttribute('name'));

  pass('test-illegal-suffixes');
});

jsunitRegister('testIdRefsRewriting', function testIdRefsRewriting() {
  var el = document.getElementById('test-id-refs-rewriting');
  el.innerHTML = '<table><tr><td id="tirr1" headers="aa bb"></td></tr></table>';
  var tirr1 = document.getElementById('tirr1');
  var real = directAccess.getAttribute(tirr1, 'headers');
  assertEquals('real ids', 'aa-xyz___ bb-xyz___', real);
  assertEquals('rewritten ids', 'aa bb', tirr1.getAttribute('headers'));
  var html = el.innerHTML;
  assertTrue('innerHTML', new RegExp('"aa bb"').test(html));
  pass('test-id-refs-rewriting');
});

jsunitRegister('testStrangeIds', function testStrangeIds() {
  function $(id) { return document.getElementById(id); }
  var el = $('test-strange-ids');
  el.innerHTML = (
      "<input id='test-strange-ids-1' name='tag[]'>\n"
      + "<input id='test-strange-ids-2' name='form$location'>\n"
      + "<span id='23skiddoo'></span>\n"
      + "<span id='8675309'></span>\n"
      + "<span id='$-.:;()[]='></span>\n");
  assertEquals('tag[]', $('test-strange-ids-1').name);
  assertEquals('form$location', $('test-strange-ids-2').name);
  assertEquals('23skiddoo', $('23skiddoo').id);
  assertEquals('8675309', $('8675309').id);
  assertEquals('$-.:;()[]=', $('$-.:;()[]=').id);
  pass('test-strange-ids');
});

jsunitRegister('testCloneNodeStructure', function testCloneNodeStructure() {
  var p = document.getElementById('test-clone-node-structure')
      .getElementsByTagName('P')[0];
  assertDomTree(
      {
        nodeType: 1,
        tagName: 'P',
        attributes: [],
        children: [
          // shallow clones contain attrs but not children.
        ]
      },
      p.cloneNode(false));
  assertDomTree(
      {
        nodeType: 1,
        tagName: 'P',
        attributes: [],
        children: [
          {
            nodeType: 3,
            nodeValue: 'I have '
          },
          {
            nodeType: 1,
            nodeName: 'B',
            attributes: [
              {
                nodeName: 'title',
                nodeValue: 'I have attributes'
              }
            ],
            children: [
              {
                nodeType: 3,
                nodeValue: 'content'
              }
            ]
          }
        ]
      },
      p.cloneNode(true));
  pass('test-clone-node-structure');
});

jsunitRegister('testCloneNodeListeners', function testCloneNodeListeners() {
  var clicked = false;
  function clickListener(event) {
    clicked = true;
  }

  var original = document.getElementById('test-clone-node-clickable');

  // Add an event to the input so we can test that event listeners are copied
  // and that clone.removeEventListener modifies only clone.
  original.addEventListener('click', clickListener);
  directAccess.click(original);
  assertTrue('initially clickable', clicked);
  clicked = false;

  var clone = original.cloneNode();
  original.parentNode.insertBefore(clone, original.nextSibling);
  // Check that listeners are not copied over.
  directAccess.click(clone);
  assertFalse('clone clickable', clicked);
  clicked = false;

  // Check that the original is still clickable.
  directAccess.click(original);
  assertTrue('original still clickable', clicked);
  clicked = false;

  pass('test-clone-node-listeners');
});

jsunitRegister('testCloneNodeDefaults', function testCloneNodeDefaults() {
  function queryStringForForm(form, useDefaults) {
    var parts = [];
    var els = form.elements;
    for (var j = 0, n = els.length; j < n; ++j) {
      var el = els[j];
      if (!el.name) { continue; }
      var values = null;
      switch (el.tagName) {
        case 'INPUT':
          switch (el.type.toUpperCase()) {
            case 'CHECKBOX':
            case 'RADIO':
              values = (useDefaults ? el.defaultChecked : el.checked)
                  ? [el.value] : null;
              break;
            default:
              values = [useDefaults ? el.defaultValue : el.value];
              break;
          }
          break;
        case 'TEXTAREA':
          values = [useDefaults ? el.defaultValue : el.value];
          break;
        case 'SELECT':
          values = [];
          for (var i = 0, opt; (opt = el.options[i]); ++i) {
            if (useDefaults ? opt.defaultSelected : opt.selected) {
              values.push(opt.value);
            }
          }
          break;
      }
      if (values !== null) {
        for (var i = 0; i < values.length; ++i) {
          parts.push(encodeURIComponent(el.name) + '='
                     + encodeURIComponent(values[i]));
        }
      }
    }
    return parts.join('&');
  }

  var form = document.getElementById('test-clone-node-defaults')
      .getElementsByTagName('FORM')[0];
  assertEquals(
      'initial form state',
      'text=default&checkbox_checked=on&radio=B&selectlist=1',
      queryStringForForm(form));

  // Change the values on the original
  form.elements.text.value = 'changed';
  form.elements.checkbox_checked.checked = false;
  form.elements.checkbox_unchecked.checked = true;
  form.elements[3].checked = true;
  form.elements.selectlist.options[1].selected = true;
  assertEquals(
      'changed form state',
      'text=changed&checkbox_unchecked=on&radio=A&selectlist=2',
      queryStringForForm(form));

  // Check the values in the clone
  var clone = form.cloneNode(true);
  // Add the clone to the DOM, or reset() below will have no effect on it
  // on Firefox.  Heisenbug.
  form.parentNode.insertBefore(clone, form);
  // HACK(mikesamuel): IE6&7 fail to update the checked state for radio buttons,
  // and IE 6 fails to updated the checked state for checkboxes until the form
  // containing it is part of the DOM.
  if (!','.split(new RegExp(',')).length) {
    clone.elements[3].checked = true;
    clone.elements.checkbox_unchecked.checked = true;
    clone.elements.checkbox_checked.checked = false;
  }
  assertEquals(
      'clone state',
      'text=changed&checkbox_unchecked=on&radio=A&selectlist=2',
      queryStringForForm(clone));
  assertEquals(
      'clone defaults',
      'text=default&checkbox_checked=on&radio=B&selectlist=1',
      queryStringForForm(clone, true));

  // Reset both and check the values on each
  clone.reset();
  assertEquals(
      'form state post clone reset',
      'text=changed&checkbox_unchecked=on&radio=A&selectlist=2',
      queryStringForForm(form));
  assertEquals(
      'clone state post reset',
      'text=default&checkbox_checked=on&radio=B&selectlist=1',
      queryStringForForm(clone));
  form.reset();
  assertEquals(
      'clone state post form reset',
      'text=default&checkbox_checked=on&radio=B&selectlist=1',
      queryStringForForm(clone));
  assertEquals(
      'form state post reset',
      'text=default&checkbox_checked=on&radio=B&selectlist=1',
      queryStringForForm(form));

  pass('test-clone-node-defaults');
});

jsunitRegister('testCloneNodeCustomAttrs', function testCloneNodeCustomAttrs() {
  var node = document.getElementById('test-clone-node-custom-attrs');
  node.setAttribute('bogus', 'foo');

  var clone = node.cloneNode(true);
  assertEquals('clone value', 'foo', clone.getAttribute('bogus'));
  assertTrue('clone has attr', clone.hasAttribute('bogus'));
  assertTrue('original has attr', node.hasAttribute('bogus'));

  clone.setAttribute('bogus', 'bar');
  assertEquals('clone changed', 'bar', clone.getAttribute('bogus'));
  assertEquals('original unchanged', 'foo', node.getAttribute('bogus'));

  clone.removeAttribute('bogus');
  assertEquals('clone deleted', null, clone.getAttribute('bogus'));
  assertFalse('deleted things do not exist', clone.hasAttribute('bogus'));
  assertEquals('original not deleted', 'foo', node.getAttribute('bogus'));
  assertTrue('original attr exists', node.hasAttribute('bogus'));

  node.setAttribute('bogus', 'boo');
  assertEquals('clone still deleted', null, clone.getAttribute('bogus'));
  assertFalse('deleted things still do not exist', clone.hasAttribute('bogus'));
  assertEquals('original changed', 'boo', node.getAttribute('bogus'));
  assertTrue('original attr still exists', node.hasAttribute('bogus'));

  pass('test-clone-node-custom-attrs');
});

jsunitRegister('testCompatMode',
               function testCompatMode() {
  assertEquals('CSS1Compat', document.compatMode);
  pass('test-compat-mode');
});

jsunitRegister('testCustomEvents',
               function testCustomEvents() {
  assertTrue(!!document.createEvent);

  // Event dispatch for custom events is synchronous
  var fired;
  var myHandler = jsunitCallback(function (event) {
    assertEquals('hiya', event.details);
    fired = true;
  });

  var eventTarget = document.getElementById('test-custom-events');
  eventTarget.addEventListener('howdy', myHandler, true);

  var event = document.createEvent('HTMLEvents');
  event.details = 'hiya';
  event.initEvent('howdy', true, true);
  assertEquals('hiya', event.details);

  eventTarget.dispatchEvent(event);
  assertTrue(fired);

  pass('test-custom-events');
});

jsunitRegister('testDomitaGlobalsAccessible',
               function testDomitaGlobalsAccessible() {
  // In Valija mode, all the "window" globals are put on the Valija
  // "outers" object. In Cajita mode, Domita demurs on the matter,
  // tastefully putting these globals on the "window" object only,
  // and not polluting Cajita's global namespace with them.

  if (directAccess.isValija) {
    assertTrue(!!HTMLElement);
    assertTrue(!!Node);
    assertTrue(!!Event);
    assertTrue(!!Text);
  } else {
    assertTrue(!!window.HTMLElement);
    assertTrue(!!window.Node);
    assertTrue(!!window.Event);
    assertTrue(!!window.Text);
  }

  if (directAccess.isValija) {
    assertEquals('function', typeof HTMLElement);
    assertEquals('function', typeof Node);
    assertEquals('function', typeof Event);
    assertEquals('function', typeof Text);
  } else {
    assertEquals('function', typeof window.HTMLElement);
    assertEquals('function', typeof window.Node);
    assertEquals('function', typeof window.Event);
    assertEquals('function', typeof window.Text);
  }

  pass('test-domita-globals-accessible');
});

jsunitRegister('testFactoriesNotBypassable',
               function testFactoriesNotBypassable() {
  // It's not possible to create an element by (new HTMLElement) in any browser
  // since factories choose the underlying implementation.
  expectFailure(
      function () { new window.HTMLElement({ nodeType: 1 }, false); },
      'HTMLElement');
  expectFailure(
      function () { new window.Node({ nodeType: 0 }, false); },
      'Node');
  expectFailure(
      function () { new window.Event({}); },
      'Event');
  expectFailure(
      function () { new window.Text({ nodeType: 3 }, false); },
      'Text');
  pass('test-factories-not-bypassable');
});

jsunitRegister('testScrolling',
               function testScrolling() {
  var initialViewPort = String([
      window.scrollLeft, window.scrollTop,
      document.defaultView.scrollLeft, document.defaultView.scrollTop]);
  assertEquals(
      'hidden',
      directAccess.getComputedStyle(directAccess.getBodyNode(), 'overflow'));

  window.scrollBy(0, 0);
  assertEquals(initialViewPort, String([
      window.scrollLeft, window.scrollTop,
      document.defaultView.scrollLeft, document.defaultView.scrollTop]));
  assertEquals(
      'hidden',
      directAccess.getComputedStyle(directAccess.getBodyNode(), 'overflow'));

  window.scrollTo(0, 10);
  assertEquals(
      'auto',
      directAccess.getComputedStyle(directAccess.getBodyNode(), 'overflow'));
  assertEquals('0,10,0,10', String([
      window.scrollLeft, window.scrollTop,
      document.defaultView.scrollLeft, document.defaultView.scrollTop]));

  window.scrollBy(10, -5);
  assertEquals(
      'auto',
      directAccess.getComputedStyle(directAccess.getBodyNode(), 'overflow'));
  assertEquals('10,5,10,5', String([
      window.scrollLeft, window.scrollTop,
      document.defaultView.scrollLeft, document.defaultView.scrollTop]));

  document.defaultView.scrollTo(0, 0);
  assertEquals(
      'auto',
      directAccess.getComputedStyle(directAccess.getBodyNode(), 'overflow'));
  assertEquals('0,0,0,0', String([
      window.scrollLeft, window.scrollTop,
      document.defaultView.scrollLeft, document.defaultView.scrollTop]));

  pass('test-scrolling');
});

jsunitRegister('testResizing',
               function testResizing() {
  function windowDims() {
    assertEquals('document.defaultView.clientWidth',
                 window.clientWidth, document.defaultView.clientWidth);
    assertEquals('document.defaultView.clientHeight',
                 window.clientHeight, document.defaultView.clientHeight);
    assertEquals('document.body.clientWidth',
                 window.clientWidth, document.body.clientWidth);
    assertEquals('document.body.clientHeight',
                 window.clientHeight, document.body.clientHeight);
    assertEquals('document.documentElement.clientWidth',
                 window.clientWidth, document.documentElement.clientWidth);
    assertEquals('document.documentElement.clientHeight',
                 window.clientHeight, document.documentElement.clientHeight);
    assertEquals('window.innerWidth', window.clientWidth, window.innerWidth);
    assertEquals('window.innerHeight', window.clientHeight, window.innerHeight);
    return String([window.clientWidth, window.clientHeight]);
  }

  function windowStyleWidth() {
    return directAccess.getComputedStyle(directAccess.getBodyNode(), 'width');
  }

  assertEquals('initial scrollable dimensions', '600,400', windowDims());
  assertEquals('initial width', '600px', windowStyleWidth());

  window.resizeBy(0, 0);
  assertEquals('scrollable dimensions 1', '600,400', windowDims());
  assertEquals('width 1', '600px', windowStyleWidth());

  window.resizeBy(-100, 200);
  assertEquals('scrollable dimensions 2', '500,600', windowDims());
  assertEquals('width 2', '500px', windowStyleWidth());

  document.defaultView.resizeTo(600, 400);
  assertEquals('scrollable dimensions 3', '600,400', windowDims());
  assertEquals('width 3', '600px', windowStyleWidth());

  pass('test-resizing');
});

jsunitRegister('testSizeProperties',
               function testSizeProperties() {
  assertEquals('number', typeof window.pageXOffset);
  assertEquals('number', typeof window.pageYOffset);
  assertTrue('sign of pageXOffset', window.pageXOffset >= 0);
  assertTrue('sign of pageYOffset', window.pageYOffset >= 0);

  var el = document.getElementById('test-size-properties');
  // includes 2*padding
  assertEquals(106, el.clientWidth);
  assertEquals(56, el.clientHeight);
  // includes 2*padding + 2*border
  assertEquals(110, el.offsetWidth);
  assertEquals(60, el.offsetHeight);

  pass('test-size-properties');
});

jsunitRegister('testDefaultView',
               function testDefaultView() {
  assertNotEquals(window, document.defaultView);
  pass('test-default-view');
});

jsunitRegister('testDocumentElement',
               function testDocumentElement() {
  assertDomTree({
      nodeType: 9,
      nodeName: '#document',
      attributes: [],
      nodeValue: null,
      children: [
        {
          nodeType: 1,
          tagName: 'HTML',
          nodeValue: null,
          attributes: [],
          children: [
            {
              nodeType: 1,
              tagName: 'HEAD',
              nodeValue: null,
              attributes: [],
              innerHTML: '<title>&lt;Untrusted Content Title&gt;</title>',
              children: [
                {
                  nodeType: 1,
                  tagName: 'TITLE',
                  nodeValue: null,
                  attributes: [],
                  innerHTML: '&lt;Untrusted Content Title&gt;',
                  children: [ {
                    nodeType: 3,
                    nodeValue: '<Untrusted Content Title>'
                  } ]
                }
              ]
            },
            {
              nodeType: 1,
              tagName: 'BODY',
              nodeValue: null,
              attributes: [],
              sameAs: document.body
            }
          ]
        }
      ]
    }, document);

  var html = document.documentElement.innerHTML;
  assertTrue(!!html.match(
    '<head><title>&lt;Untrusted Content Title&gt;</title></head><body>'));

  pass('test-document-element');
});

var testWindowObjectVariable;

jsunitRegister('testWindowObject',
               function testWindowObject() {
  // Check to see that in valija globals are properties of window
  if (valijaMode) {
    testWindowObjectVariable = 3;
    assertEquals(testWindowObjectVariable, window.testWindowObjectVariable);
    assertEquals(testWindowObjectVariable, 3);
  }
  pass('test-window-object');
});

jsunitRegister('testBoundingClientRect',
               function testBoundingClientRect() {
  // Grab two elements defined in domita_test.html
  var absPos = document.getElementById('absolutely-positioned');
  var relPos = document.getElementById('relatively-positioned');

  window.scrollLeft = window.scrollTop = 0;
  var absRect = absPos.getBoundingClientRect();
  var relRect = relPos.getBoundingClientRect();

  function rectToString(rect) {
    return ('top: ' + rect.top + ', left: ' + rect.left
            + ', right: ' + rect.right + ', bottom: ' + rect.bottom);
  }

  assertEquals('absRect', 'top: 3, left: 11, right: 111, bottom: 43',
               rectToString(absRect));
  // Since the first rect is absolutely positioned, it does not occupy space in
  // its parent, so both rects overlap.
  assertEquals('relRect', 'top: 0, left: 9, right: 109, bottom: 40',
               rectToString(relRect));

  pass('test-bounding-client-rect');
});

jsunitRegister('testAttributeNodes',
               function testAttributeNodes() {
  var cb = document.getElementById('test-attribute-nodes-onclick');

  var attrNode = cb.getAttributeNode('id');
  assertEquals('test-attribute-nodes-onclick', attrNode.value);
  assertEquals(true, attrNode.specified);
  assertEquals(cb, attrNode.ownerElement);
  assertEquals('id', attrNode.name);

  assertNoAttr(cb.getAttributeNode('name'));

  function assertNoAttr(attrNode) {
    if (attrNode === null) { return; }
    assertFalse('specified ' + attrNode.name, attrNode.specified);
    assertEquals(
        'non blank value for ' + attrNode.name, '', attrNode.value || '');
  }

  function checkScriptAttrNode(attrNode) {
    if (attrNode == null || !attrNode.specified) {
      return;  // Works if node not present.
    }
    // If it is present, it had better be rewritten.
    var scriptAttrRE = new RegExp('\\bplugin_dispatchEvent___\\(');

    function assertScript(value) {
      value = '' + value;
      assertTrue(scriptAttrRE.test(value));
    }

    assertScript(attrNode.value);
    assertScript(attrNode.nodeValue);
  }

  var onclickAttrNode = cb.getAttributeNode('onclick');
  checkScriptAttrNode(onclickAttrNode);

  try {
    cb.onclick = 'globalSideEffect();';
  } catch (ex) {}
  if (onclickAttrNode) {
    try {
      onclickAttrNode.value = 'globalSideEffect();';
    } catch (ex) {}
  }
  checkScriptAttrNode(onclickAttrNode);

  pass('test-attribute-nodes');
});

jsunitRegister('testShorthandCss',
               function testShorthandCss() {
  var body = document.body;
  var container = document.getElementById('test-shorthand-css');
  var elementRef = document.createElement('DIV');
  elementRef.id = 'foo';
  elementRef.innerHTML = 'style me shortly';
  container.appendChild(elementRef);
  elementRef.style.border = '5px dashed blue';
  assertEquals('shorthand width set', elementRef.style.borderTopWidth, '5px');
  assertEquals('shorthand color set', elementRef.style.borderTopColor, 'blue');
  assertEquals('shorthand style set', elementRef.style.borderTopStyle, 'dashed');

  pass('test-shorthand-css');
});

jsunitRegister('testAnchorComputedStylesDontLeakHistory',
               function testAnchorComputedStylesDontLeakHistory() {
  function getColor(id) {
    return window.getComputedStyle(document.getElementById(id), null).color;
  }

  assertColor({rgb: 0x030609}, getColor('direct-visited'));
  assertColor({rgb: 0x030609}, getColor('nested-visited'));
  assertColor({rgb: 0x030609}, getColor('direct-link'));
  assertColor({rgb: 0x030609}, getColor('nested-link'));

  function getColorPV(id) {
    return window.getComputedStyle(document.getElementById(id), null)
        .getPropertyValue('color');
  }

  assertColor({rgb: 0x030609}, getColorPV('direct-visited'));
  assertColor({rgb: 0x030609}, getColorPV('nested-visited'));
  assertColor({rgb: 0x030609}, getColorPV('direct-link'));
  assertColor({rgb: 0x030609}, getColorPV('nested-link'));

  var a = document.createElement('a');
  var p0 = document.createElement('p');
  var p1 = document.createElement('p');

  var container = document.getElementById(
      'test-anchor-computed-styles-dont-leak-history');

  container.appendChild(p0);
  container.appendChild(a);
  a.appendChild(p1);

  // The COLOR property is history sensitive
  p0.style.color = p1.style.color = '#c0c0c0';
  // The PADDING-LEFT property is history insensitive
  p0.style.paddingLeft = p1.style.paddingLeft = '123px';

  // The 'p0' element should have computed style values exactly as were
  // explicitly set, since nothing on a DIV is history sensitive.
  assertColor(
      {rgb: 0xc0c0c0},
      window.getComputedStyle(p0, null).color);
  assertColor(
      {rgb: 0xc0c0c0},
      window.getComputedStyle(p0, null).getPropertyValue('color'));
  assertEquals(
      '123px',
      window.getComputedStyle(p0, null).paddingLeft);
  assertEquals(
       '123px',
       window.getComputedStyle(p0, null).getPropertyValue('padding-left'));

  // The 'p1' element, since it is contained within an A element, should have
  // computed COLOR value inherited from the top-level container element of
  // this DOMita instance (since COLOR is an allowed history-sensitive
  // property), and a computed PADDING-LEFT value exactly as explicitly set
  // (since the CSS rewriter does not allow PADDING-LEFT to be assigned in a
  // history sensitive manner).
  assertColor(
      {rgb: 0x030609},
      window.getComputedStyle(p1, null).color);
  assertColor(
      {rgb: 0x030609},
       window.getComputedStyle(p1, null).getPropertyValue('color'));
  assertEquals(
      '123px',
      window.getComputedStyle(p1, null).paddingLeft);
   assertEquals(
       '123px',
       window.getComputedStyle(p1, null).getPropertyValue('padding-left'));

  pass('test-anchor-computed-styles-dont-leak-history');
});

jsunitRegister('testTableElements',
               function testTableElements() {
  var tr_b1 = document.getElementById('test-table-elements-tr-b1');
  assertEquals(1, tr_b1.sectionRowIndex);
  assertEquals(2, tr_b1.rowIndex);
  pass('test-table-elements');
});

jsunitRegister('testThisInEventHandlers',
               function testThisInEventHandlers() {
  var inp = document.getElementById('test-this-in-event-handlers-1');

  // By declaring f() to be cajita, but supplying it as the 'call'
  // property of the object passed to the event listener, we get
  // access to the value the function is supposed to use for the
  // 'this' keyword, even in cajita.
  var f = jsunitCallback(
      function fcb($dis, event, thisNode) {
        'use strict';
        'use cajita';
        // In an event handler, "this" should be bound to the node.
        assertEquals($dis, thisNode);
        pass('test-this-in-event-handlers');
      });
  inp.addEventListener('click', {call: f}, false);
  directAccess.click(inp);
});

// http://code.google.com/p/google-caja/issues/detail?id=1066
jsunitRegister('testForAttribute', function testForAttribute() {
  var label = document.createElement('label');
  assertFalse(label.hasAttribute('for'));
  label.setAttribute('for', 'X');
  assertEquals('X', label.getAttribute('for'));
  assertEquals('X', label.htmlFor);
  assertTrue(label.hasAttribute('for'));
  label.htmlFor = 'Y';
  assertEquals('Y', label.getAttribute('for'));
  assertEquals('Y', label.htmlFor);
  assertTrue(label.hasAttribute('for'));
  pass('test-for-attribute');
});

jsunitRegister('testRowCell',
               function testRowCell() {
  var table = document.getElementById('test-row-cell-1');
  assertEquals(0, table.rows.length);
  table.insertRow(-1);
  assertEquals(table.rows.length, 1);
  assertEquals(0, table.rows.item(0).cells.length);
  table.rows.item(0).insertCell(-1);
  var cell = table.rows.item(0).insertCell(-1);
  assertEquals(1, cell.cellIndex);
  assertEquals(2, table.rows.item(0).cells.length);
  table.rows.item(0).deleteCell(1);
  table.rows.item(0).deleteCell(0);
  assertEquals(0, table.rows.item(0).cells.length);
  var tableDeleteRow = false, tbodyDeleteRow = false;
  try {
    table.deleteRow(2);
  } catch (e) {
    assertEquals('Index size error.', e.message);
    tableDeleteRow = true;
  }
  try {
    document.getElementById('test-row-cell-2').deleteRow(2);
  } catch (e) {
    assertEquals('Index size error.', e.message);
    tbodyDeleteRow = true;
  }
  if (tableDeleteRow === true && tbodyDeleteRow === true) {
    pass('test-row-cell');
  }
});

jsunitRegister('testNegativeIndices',
               function testNegativeIndices() {
  // Under Firefox, there are many undocumented properties
  // with negative indices; see
  // http://www.thespanner.co.uk/2009/07/14/hidden-firefox-properties-revisited/
  // http://webreflection.blogspot.com/2009/06/javascript-arguments-weridness.html
  var i;
  function f(a, b, c) {}
  (function () {
    for (i = -1; i > -10; --i) {
      assertEquals(f[i], void 0);
      assertEquals(void 0, (new RegExp('.'))[i]);
      assertEquals(void 0, arguments[i]);
    }
  })();
  pass('test-negative-indices');
});

jsunitRegister('testIframeShim',
               function testIframeShim() {
  var ifr = document.createElement('iframe');
  ifr.height = 5;
  ifr.width = 6;
  ifr.frameBorder = 1;
  ifr.name = 'test';
  ifr.src = 'http://www.google.com';
  ifr.setAttribute('application', 'yes');
  document.getElementById('test-iframe-shim').appendChild(ifr);
  assertEquals('5', ifr.getAttribute('height'));
  assertEquals('6', ifr.getAttribute('width'));
  assertEquals('1', ifr.getAttribute('frameBorder'));
  assertEquals(null, ifr.getAttribute('name'));
  assertEquals(null, ifr.getAttribute('src'));
  assertEquals(void 0, ifr.name);
  assertEquals(void 0, ifr.src);
  pass('test-iframe-shim');
});

// make sure emitter isn't confused by form element named "id"
jsunitRegister('testEmitterId',
               function testEmitterId() {

  // did emitter find form.id correctly?
  var el = document.getElementById('test-emitter-id-0');
  assertTrue('el is truthy', !!el);

  // make sure we're still the first form
  var forms = document.getElementsByTagName('form');
  assertEquals(el.id, forms[0].id);

  pass('test-emitter-id');
});

jsunitRegister('testEmitterIe',
               function testEmitterIe() {
  // did emitter finish removing marker spans?
  var el = document.getElementById('test-emitter-ie');
  var kids = el.getElementsByTagName('span');
  assertEquals(0, kids.length);

  // did emitter reattach everything?
  var html = el.innerHTML;
  for (var k = 0; k < 5; ++k) {
    var duck = 'duck-' + k;
    assertNotEquals(duck, -1, html.indexOf(duck));
  }

  pass('test-emitter-ie');
});

jsunitRegister('testUsemap',
               function testUsemap() {
  assertEquals(
      (''
       + '<map name="foo-xyz___">'
       + '<area href="http://example.com/'
       + '?mime-type=*%2F*&amp;uri=areatarget.html"'
       + ' target="_blank">'
       + '</map>'
       + '<img usemap="#foo-xyz___"'
       + ' src="http://example.com/?mime-type=image%2F*&amp;uri=mappic.gif">'),
      directAccess.getInnerHTML(document.getElementById('test-usemap')));
  pass('test-usemap');               
});

jsunitRegister('testDocumentBodyAppendChild',
               function testDocumentBodyAppendChild() {
  var notWhitespaceRe = new RegExp('\\S');
  function getPrevNonWhitespace(prev) {
    while (prev.nodeType === 3 && !notWhitespaceRe.test(prev.nodeValue)) {
      prev = prev.previousSibling;
    }
    return prev;
  }

  function getNextNonWhitespace(next) {
    while (next.nodeType === 3 && !notWhitespaceRe.test(next.nodeValue)) {
      next = next.nextSibling;
    }
    return next;
  }

  var body = document.body;
  var container = document.getElementById('test-document-body-appendChild');
  var last = getPrevNonWhitespace(document.body.lastChild);
  assertEquals('container is not last', container, last);

  var lastest = document.createElement('DIV');
  lastest.innerHTML = 'lastest';
  body.appendChild(lastest);
  assertEquals('lastest in wrong place',
               lastest, getNextNonWhitespace(last.nextSibling));
  assertEquals('lastest is not last',
               lastest, getPrevNonWhitespace(body.lastChild));
  assertEquals('body changed', body, document.body);
  assertEquals('parent is not body', lastest.parentNode, body);
  pass('test-document-body-appendChild');
});

jsunitRegister('testFocusBlur',
               function testFocusBlur() {
  var input = document.getElementById('test-focus-blur-1');
  input.focus();
  input.blur();
  // IE specific methods
  if (input.hasFocus) {
    assertEquals('boolean', typeof input.hasFocus());
  }
  if (input.setActive) {
    input.setActive();
  }
  // TODO: can't verify focus changes in webdriver, because webdriver runs
  // without focusing the browser window, so onfocus never gets fired.
  pass('test-focus-blur');
});

// form:onreset uses the same logic path as input:onfocus
jsunitRegister('testOnReset',
               function testOnReset() {
  var form = document.getElementById('test-onreset-form');
  form.addEventListener('reset',
      jsunitCallback(
          function onreset() { pass('test-onreset'); }),
      false);
});

function testAsyncModuleLoader(load, includeScript, prefix) {
  directAccess.clearModuleCache();
  if (!valijaMode) {
    var m = load.async('../a');
    var f1 = jsunitCallback(function f1cb(module) {
      var r = module({x: 1, y: 2});
      assertEquals(r, 3);
      pass(prefix + '-module-loader');
    });
    var f2 = jsunitCallback(function f2cb(reason) {
      fail("Loading module a failed, " + reason);
    });
    Q.when(m, f1, f2);
  } else {
    var m = includeScript.async('../x');
    var f1 = jsunitCallback(function f1cb(result) {
      assertEquals(x, 3);
      pass(prefix + '-module-loader');
    });
    var f2 = jsunitCallback(function f2cb(reason) {
      fail("Loading module x failed, " + reason);
    });
    Q.when(m, f1, f2);
  }
}

jsunitRegister('testXhrModuleLoader',
               function testXhrModuleLoader() {
  testAsyncModuleLoader(xhrModuleLoad, xhrIncludeScript, "xhr");
});

jsunitRegister('testScriptModuleLoader',
               function testScriptModuleLoader() {
  testAsyncModuleLoader(scriptModuleLoad, scriptIncludeScript, "script");
});

function testAsyncModuleLoader2(load, prefix) {
  directAccess.clearModuleCache();
  if (!valijaMode) {
    var m = load.async('../foo/b');
    var f1 = jsunitCallback(function f1cb(module) {
      var r = module({x: 1, y: 2, Q: Q, fail: fail});
      Q.when(r, jsunitCallback(function(result) {
                  assertEquals(result, 5);
                  pass(prefix + '-module-loader-2');
                }),
                jsunitCallback(function(reason) {
                  fail("Waiting for result failed, " + reason);
                }));
    });
    var f2 = jsunitCallback(function f2cb(reason) {
      fail("loading module B failed, " + reason);
    });
    Q.when(m, f1, f2);
  } else {
    pass(prefix + '-module-loader-2');
  }
}

jsunitRegister('testXhrModuleLoader2',
        function testXhrModuleLoader2() {
  testAsyncModuleLoader2(xhrModuleLoad, "xhr");
});

jsunitRegister('testScriptModuleLoader2',
               function testScriptModuleLoader2() {
  testAsyncModuleLoader2(scriptModuleLoad, "script");
});

function testAsyncModuleLoaderFailure(load, includeScript, prefix) {
  directAccess.clearModuleCache();
  var f1 = jsunitCallback(function f1cb(module) {
      fail('It should not be resolved.');
  });

  var f2 = jsunitCallback(function f2cb(reason) {
    if (reason.substring(0, 22) === 'Retrieving the module ') {
      pass(prefix + '-module-loader-failure');
    }
  });

  if (!valijaMode) {
    var m = xhrModuleLoad.async('../b');
    Q.when(m, f1, f2);
  } else {
    var m = xhrIncludeScript.async('../foo/x');
    Q.when(m, f1, f2);
  }
}

jsunitRegister('testXhrModuleLoaderFailure',
               function testXhrModuleLoaderFailure() {
  testAsyncModuleLoaderFailure(xhrModuleLoad, xhrIncludeScript, 'xhr');
});

jsunitRegister('testScriptModuleLoaderFailure',
               function testScriptModuleLoaderFailure() {
  testAsyncModuleLoaderFailure(scriptModuleLoad, scriptIncludeScript, 'script');
});

jsunitRegister('testRecursiveModule',
               function testRecursiveModule() {
  directAccess.clearModuleCache();
  if (!valijaMode) {
    var m = scriptModuleLoad.async('../recursion');
    var f1 = jsunitCallback(function f1cb(module) {
      var r = module({x: 5, Q: Q});
        Q.when(r, jsunitCallback(function(result) {
                    assertEquals(result, 120);
                    pass('recursive-module');
                  }),
                  jsunitCallback(function(reason) {
                    fail("Waiting for result failed, " + reason);
                  }));
      });
    var f2 = jsunitCallback(function f2cb(reason) {
      fail("Loading module Recursion failed, " + reason);
    });
    Q.when(m, f1, f2);
  } else {
    pass('recursive-module');
  }
});

jsunitRegister('testCommonJsModule',
               function testCommonJsModule() {
  directAccess.clearModuleCache();
  if (valijaMode) {
    var m = commonJsModuleLoad('../foo/inc');
    Q.when(m, jsunitCallback(function(module) {
                var r = module.inc(env.x);
                Q.when(r, jsunitCallback(function(result) {
                            assertEquals(result, 7);
                            pass("common-js-module");
                          }),
                          jsunitCallback(function(reason) {
                            fail(reason);
                          }));
                  }),
                  jsunitCallback(function(reason) {
                    fail("Loading module inc failed, " + reason);
                  }));
  } else {
    pass("common-js-module");
  }
});

jsunitRegister('testCommonJsRecursiveModule',
               function testCommonJsRecursiveModule() {
  directAccess.clearModuleCache();
  if (valijaMode) {
    var m = commonJsModuleLoad('../commonJsRecursion');
    Q.when(m, jsunitCallback(function(module) {
                var r = module.isNonNegative(env.x);
                Q.when(r, jsunitCallback(function(result) {
                            assertEquals(result, true);
                            pass("common-js-recursive-module");
                          }),
                          jsunitCallback(function(reason) {
                            fail("Waiting for result failed, " + reason);
                          }));
              }),
              jsunitCallback(function(reason) {
                fail("Loading module CommonJsRecursion failed, " + reason);
              }));
  } else {
    pass("common-js-recursive-module");
  }
});

function testUnbundledModuleLoader(load, prefix) {
  //directAccess.clearModuleCache();
  if (!valijaMode) {
    var m = load.async('../foo/f');
    var f1 = jsunitCallback(function f1cb(module) {
               var result = module({x: 1, y: 2});
               assertEquals(result, 5);
               pass(prefix + '-unbundled-module-loader');
             });
    var f2 = jsunitCallback(function f2cb(reason) {
      fail("loading module F failed, " + reason);
    });
    Q.when(m, f1, f2);
  } else {
    pass(prefix + '-unbundled-module-loader');
  }
}

jsunitRegister('testXhrUnbundledModuleLoader',
               function testXhrUnbundledModuleLoader() {
  testUnbundledModuleLoader(xhrModuleLoad, "xhr");
});

jsunitRegister('testScriptUnbundledModuleLoader',
               function testScriptUnbundledModuleLoader() {
  testUnbundledModuleLoader(scriptModuleLoad, "script");
});

jsunitRegister('testStaticCommonJsModule',
               function testStaticCommonJsModule() {
  directAccess.clearModuleCache();
  if (valijaMode) {
    var m = commonJsModuleLoad('../foo/staticinc');
    Q.when(m, jsunitCallback(function whenModuleLoaded(module) {
                var r = module.inc(env.w);
                assertEquals(r, 7);
                pass("static-common-js-module");
              }),
              jsunitCallback(function(reason) {
                fail("Loading module staticinc failed, " + reason);
              }));
  } else {
    pass("static-common-js-module");
  }
});

// Before onload events fire
jsunitRun();
</script>
