<html>
<head>
<script type=text/javascript src=../../plugin/asserts.js></script>
<script type=text/javascript src=util.js></script>
<script type=text/javascript src=html.js></script>
<script type=text/javascript src=uformat.js></script>
<script type=text/javascript src=hcalendar.js></script>
<script type=text/javascript src=hcalendar_test.js></script>

<style type="text/css">
.good { color: #080 }
.bad { color: #800; text-weight: bold }
.detail { margin-left: 2em; white-space: pre }
</style>
</head>
<body>
<ul id="log"></ul>

<script type="text/javascript">
function loadHtml(html, continuation) {
  // If run inside Rhino, update the content the easy way
  if (/^content:/.test(String(window.location))) {
    window.location = 'content:' + encodeURIComponent(html);
    continuation(window.document);
  } else {
    console.log('creating iframe location=' + window.location);
    var iframe = document.createElement('IFRAME');
    iframe.width = iframe.height = 100;
    document.body.appendChild(iframe);
    try {
      iframe.contentDocument.write(html);
      continuation(iframe.contentDocument);
    } finally {
      document.body.removeChild(iframe);
    }
  }
}

(function () {

  function emit(text, className) {
    var log = document.getElementById('log');
    if (log) {
      var li = document.createElement('li');
      li.className = className;
      li.appendChild(document.createTextNode(text));
      log.appendChild(li);
    }
    if (this.console) {
      if ('bad' === className) {
        console.error(text);
        console.trace();
      } else {
        console.log(text);
      }
    }
  }

  var testNames = [];
  for (var k in this) {
    if (/^test/.test(k) && 'function' === typeof this[k]) {
      testNames.push(k);
    }
  }

  assertTrue(testNames.length > 0);

  testNames.sort();

  var errors = [];

  for (var i = 0; i < testNames.length; ++i) {
    var testName = testNames[i];
    this.console && this.console.time(testName);
    var pass = false;
    var error = null;
    try {
      this[testName]();
      pass = true;
    } catch (e) {
      error = e;
      errors.push(error + (error.stack ? '\n' + error.stack : ''));
    }
    this.console && this.console.timeEnd(testName);

    if (pass) {
      emit(testName + ' passed', 'good');
    } else {
      emit(testName + ' failed : ' + error, 'bad');
      if (error && error.stack) {
        emit(error.stack, 'detail');
      }
    }
  }

  if (errors.length) {
    throw errors.join('\n\n');
  }
})();
</script>
</body>
</html>
