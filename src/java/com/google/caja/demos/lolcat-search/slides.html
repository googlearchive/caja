<html>
<head>
  <title>Securing JavaScript &mdash; Object-Capabilities</title>
  <style type="text/css">
    /* Hide the dynamic bits until we know js works */
    #dynamic { display: none }

    /* Hide all slides initially */
    .js-works .slide { display: none }
    .js-works #dynamic { display: block }

    /* When printing, print all. */
    @media print {
      .slide { display: block !important }
      .noprint { display: none !important }
    }

    small { font-size: 50% }

    img { margin: 4px }

    li.slide {
      list-style: none;
      border: 1px solid black;
      margin: 4px
    }

    .slide {
      text-align: center;
      font-size: 166%;
      /* meant for display on a 1024 x 768 browser window */
      width: 950px;
      height: 550px
    }

    #toc td { font-size: 166% }
    #toc ol { margin-left: 0; margin-right: 0 }

    span.button {
      font-size: 150%; border: 0; background: white; color: blue;
      cursor: pointer
    }

    .slide ul, .slide ol, .slide pre {
      text-align: left; margin-left: 3em; margin-right: 3em;
    }

    .slide blockquote { text-align: left; margin-left: 6em; margin-right: 3em; }

    .slide td { padding-left: 1em; }

    li > h1 { margin-top: 0 }

    .cmt { color: #800 }
    .str { color: #080 }
  </style>

  <script type="text/javascript"><!--
(function () {

  var slides;
  var currentSlide;

  function initSlides() {
    // Find the slides, and make a table of contents.
    slides = getElementsByClass(document.body, 'LI', 'slide');

    // Make sure they all have unique IDs
    autoAssignIds(slides, 'slide_autonum_');

    // Create a contents slide dynamically from the <H1> content of the others.
    var toc = makeTableOfContents(slides);
    slides[0].parentNode.insertBefore(toc, slides[0]);
    slides.unshift(toc);

    // Create and display the next/prev controls.
    createControls(document.getElementById('controls'));

    // Show the first slide, or if the anchor corresponds to a slide id, then
    // show that slide.
    setCurrentSlide(slideIndexFromId(slides, idFromAnchor(location.hash)) || 0);

    // Hide all the other slides, now that we know that javascript works in
    // this browser.
    document.body.className += ' js-works';
  }

  function getElementsByClass(root, tagName, className) {
    var pattern = new RegExp('\\b' + className + '\\b');
    var slides = [];
    var candidates = root.getElementsByTagName(tagName);
    for (var i = 0, n = candidates.length; i < n; ++i) {
      if (pattern.test(candidates[i].className)) {
        slides.push(candidates[i]);
      }
    }
    return slides;
  }

  function idFromAnchor(anchor) {
    return anchor && anchor.replace(/^\#/, '');
  }

  function slideIndexFromId(slides, slideId) {
    if (slideId) {
      for (var i = slides.length; --i >= 0;) {
        if (slides[i].id === slideId) { return i; }
      }
    }
    return undefined;
  }

  function autoAssignIds(nodes, prefix) {
    for (var i = 0; i < nodes.length; ++i) {
      var node = nodes[i];
      node.id = node.id || prefix + i;
    }
  }

  function makeTableOfContents(slides) {
    var tocNode = document.createElement('LI');
    tocNode.className = 'slide';
    tocNode.id = 'toc';

    var tocTable = document.createElement('TABLE');
    tocNode.appendChild(tocTable);

    var tocRow = document.createElement('TR');
    tocRow.setAttribute('VALIGN', 'top');
    tocTable.appendChild(tocRow);

    var contents;

    for (var i = 0; i < slides.length; ++i) {
      if (!(i % 12)) {
        contents = document.createElement('OL');
        var tocCell = document.createElement('TD');
        tocCell.appendChild(contents);
        tocRow.appendChild(tocCell);

        contents.setAttribute('start', String(1 + i));
      }

      var slide = slides[i];
      var title = slide.getElementsByTagName('h1');
      if (title.length) {
        var entry = document.createElement('LI');
        var link = document.createElement('A');
        link.href = '#' + encodeURIComponent(slide.id);
        link.onclick = slideShower(slide.id);
        link.innerHTML = title[0].innerHTML;
        entry.appendChild(link);
        contents.appendChild(entry);
      }
    }
    return tocNode;
  }

  function createControls(controlContainer) {
    var prevButton = document.createElement('SPAN');
    prevButton.className = 'button';
    prevButton.onclick = function () {
      setCurrentSlide((currentSlide + slides.length - 1) % slides.length);
    };
    prevButton.appendChild(document.createTextNode('\u2190'));

    var tocButton = document.createElement('SPAN');
    tocButton.className = 'button';
    tocButton.onclick = slideShower('toc');
    tocButton.appendChild(document.createTextNode('TOC'));

    var nextButton = document.createElement('SPAN');
    nextButton.className = 'button';
    nextButton.onclick = function () {
      setCurrentSlide((currentSlide + 1) % slides.length);
    };
    nextButton.appendChild(document.createTextNode('\u2192'));

    controlContainer.appendChild(prevButton);
    controlContainer.appendChild(tocButton);
    controlContainer.appendChild(nextButton);

    document.body.onkeypress = function (event) {
      event = event || window.event;
      switch (String.fromCharCode(event.charCode)) {
        case 'p':
          prevButton.onclick();
          break;
        case 'n':
          nextButton.onclick();
          break;
        case 't':
          tocButton.onclick();
          break;
      }
    };
  }

  function setCurrentSlide(slideIndex) {
    if (slideIndex === currentSlide) { return; }
    if (currentSlide !== undefined) {
      slides[currentSlide].style.display = '';
    }
    currentSlide = slideIndex;
    var slide = slides[currentSlide];
    window.location = '#' + encodeURIComponent(slide.id);
    slide.style.display = 'block';

    document.getElementById('counter').firstChild.nodeValue
        = (slideIndex + 1) + ' / ' + slides.length;
  }

  function slideShower(slideId) {
    return function () {
      var slideIndex = slideIndexFromId(slides, slideId);
      slideIndex !== undefined && setCurrentSlide(slideIndex);
      document.getElementById('controls').focus();
    };
  }

  this.initSlides = initSlides;
})();
  --></script>
</head>
<body bgcolor=white
 onload="initSlides(); document.getElementById('controls').focus()">

  <div class=noprint id=dynamic
   ><a id=controls></a> (<span id=counter>&nbsp;</span>)</div>

  <ul>
    <li class=slide>
      <h1>Caja &mdash; Securing WebApps</h1>

      <tt><a href="http://code.google.com/p/google-caja/"
        >http://code.google.com/p/google-caja/</a></tt>

      <p>Goal: A fundamentally secure foundation for Web Apps that runs
      in existing browsers and is usable by non security-experts.</p>

      <br>

      <p>Rewrites JavaScript/HTML/CSS</p>
      <p>Enforces Object-Capabilities</p>
      <p>Gadget writers use familiar tools</p>
    </li>

    <li class=slide id=goals>
      <h1>Security Goals</h1>

      <p>Gadget can't interfere with the container</p>
      <p>Nor with other gadgets</p>
      <p>But mutually suspicious gadgets can cooperate</p>
      <p>And can be safely given user data</p>
      <p>With restrictions</p>
    </li>

    <li class=slide id=audience>
      <h1>Target Audience</h1>

      <p>Not security experts
      <p>Familiar with web technologies
      <p>Comfortable with acronyms: JS, HTML, CSS, PHP
      <p>Have specific domain knowledge that C.S. graduates lack
    </li>

    <li class=slide id=playgrounds>
      <h1>Sandboxes &rarr; Playgrounds</h1>

      <img src=sandboxes-to-playgrounds.png style="float: right">
      <div style="width: 50%">
        <p><b>Old</b>: untrusted code in separate domains.
        Collaboration is hard.

        <p><b>New</b>: different pieces of code in same domain.  Don't
        trust each other.  Collaborate via normal object passing and
        method calls.
      </div>
    </li>

    <li class=slide id=capabilities>
      <h1>Object-Capabilities</h1>

      <p>An O.C. Language is an OO language that ensures:</p>
      <ul>
        <li>Objects are encapsulated
          &mdash; only accessed via public API.</li>
        <li>Objects can only influence the outside world
          by sending messages on references.</li>
        <li>An object's creator can deny access by not
          providing references.</li>
      </ul>

      <small>from Marc S.: <i>Emily: A High Performance Language for Enabling
        Secure Cooperation</i></small>
    </li>

    <li class=slide id=best-practices>
      <h1>O.C. Builds on Good SW Practices</h1>
      <center><table style=font-size:100%>
        <tr><td>Separation of Duties<td>&rarr;<td>Separation of Authority</tr>
        <tr><td>Information hiding<td>&rarr;<td>Encapsulation</tr>
        <tr><td>Object orientation<td>&rarr;<td>Capabilities</tr>
        <tr><td>Dependency Injection<td>&rarr;<td>Authority Injection</tr>
        <tr><td><td><td><center>&darr;<br>POLA<br>(Principle of Least Authority)</center></tr>
      </table></center>
    </li>

    <li class=slide id=flexible-security>
      <h1>O.C. Provides Flexible Security</h1>

      <p>Static policies require blanket rules.  O.C. allows exceptions by
      granting references.</p>
          <blockquote>
          A policy, safe HTML, can be enforced by a sanitizer function that
          returns an HTML capability.  But an exemption can be made
          for HTML from a trusted source by passing in a reference to an HTML
          capability.
          </blockquote>
      <p>Independent of authentication and identity issues.</p>
    </li>

    <li class=slide id=demo>
      <h1>Demo: LOLcat Search</h1>

      <img src=lolcat-search.png style=float:right>

      <p>Two cooperating gadgets:</p>

      <div><b>Searchbox</b></div>
      <p>Displays a search form and uses a search engine provided by the
      container to fetch and display results.</p>

      <div><b>Kittens</b></div>
      <p>When a search result is clicked on, displays pictures of cute
      kittens using the search engine supplied by the container.</p>
    </li>

    <li class=slide id=extensibility>
      <h1>Extensible Rewriting<small><code> (<a
         href="http://code.google.com/p/google-caja/wiki/PipelineConfiguration"
       >http://tinyurl.com/2xr5t8</a>)</code></small></h1>

      <img src="../../../../../../../doc/images/Cajoler-Arch.png"
       style="margin-top: -1em"
       onclick=
       "this.src='../../../../../../../doc/images/Cajoler-Arch-Tweaked.png'">
    </li>

    <li class=slide>
      <h1>JS &amp; CSS extracted</h1>

      <pre>&lt;script src="searchbox.js"&gt;&lt;/script&gt;
&lt;link rel=stylesheet href="searchbox.css" /&gt;
&lt;form&gt;
  &lt;input type=text size=60 name=q&gt;
  &lt;input type=button value=Search onclick="<b>doSearch(this)</b>"&gt;
&lt;/form&gt;</pre>

      <p>Javascript from <tt>script</tt> and <tt>onclick</tt> handlers
      extracted and sanitized.  HTML rendered by javascript:</p>

      <pre>
___OUTERS___.emitHtml___(<span class=str>'&lt;form onsubmit=\"return false\"&gt;\n'</span>
     + <span class=str>'    &lt;input type=\"text\" size=\"60\" name=\"q\"&gt;\n'</span>
     + <span class=str>'    &lt;input type=\"button\" value=\"Search\"'</span>
     + <span class=str>' onclick=\"<b>return plugin_dispatchEvent___(&hellip;)</b>\"&gt;\n'</span>
     + <span class=str>'  &lt;/form&gt;'</span>);
      </pre>
    </li>

    <li class=slide>
      <h1>Style Rules &amp; IDs rewritten</h1>

      <p>To prevent CSS styles interfering, <tt>class</tt>es, <tt>id</tt>s, and
      CSS rules are rewritten, and styles are sanitized:</p>

      <pre>
<span class=cmt>/* searchbox.css */</span>
<b>#results</b> li { list-style-type: none; margin-top: .5em;
              border-bottom: 1px dotted #888 }</pre>
      &darr;
      <pre>
<span class=cmt>/* searchbox-cajoled.css */</span>
<b>.searchbox #:results</b> li {
  list-style-type: none;
  margin-top: .5em;
  border-bottom: 1px dotted #888
}
</pre>

    <li class=slide>
      <h1>Caja Rewrites Javascript</h1>

      <p>Global references rewritten, and libraries are "tamed".</p>

      <pre>
<span class=cmt>// Gadget Javascript</span>
<b>document</b>.getElementById(<span class=str>'foo'</span>)</pre>
      &darr;
      <pre>
<span class=cmt>// Cajoled Javascript</span>
___OUTERS___.<b>document</b>&hellip;</pre>

      <p>When the gadget asks for the node with id <code>foo</code> we
      substitute a "tamed" version of the DOM node with id
      <tt>searchbox-foo</tt>.</p>
    </li>

    <li class=slide>
      <h1>Container Loads Gadgets</h1>

      <pre>
<span class=cmt>&lt;!-- Container HTML --&gt;</span>
&lt;div id="<b>searchbox-</b>base" class="<b>searchbox</b>"&gt;&lt;/div&gt;
&hellip;
&lt;div class="<b>searchbox</b>"&gt;&lt;ul id="<b>searchbox-</b>results"&gt;&lt;/ul&gt;&lt;/div&gt;

&lt;script type="text/javascript"&gt;
  <span class=cmt>// Create a fake "Global" object for the gadget</span>
  var searchBoxOuters = ___.copy(___.sharedOuters);
  <span class=cmt>// Create the fake document object.</span>
  attachDocumentStubs(<span class=str>'<b>searchbox-</b>'</span>, searchBoxOuters);
  setGadgetRoot(document.getElementById(<span class=str>'<b>searchbox-</b>base'</span>));
  &hellip;
&lt;/script&gt;
<span class=cmt>&lt;!-- Load the gadget JS &amp; CSS --&gt;</span>
&lt;script type="text/javascript" src=<b>searchbox-cajoled.js</b>&gt;&lt;/script&gt;
&lt;link rel="stylesheet" type="text/css" href="<b>searchbox-cajoled.css</b>"&gt;
</pre>
    </li>

    <li class=slide>
      <h1>Container Injects Authority</h1>

<pre>
var searchEngine = new SearchEngine();

<span class=cmt>// Provide both modules an interface to Google's AJAX Search APIs.</span>
searchBoxOuters.searchEngine = kittensOuters.searchEngine
    = searchEngine;

<span class=cmt>// Allow searchBoxOuters to talk to kittens.</span>
searchBoxOuters.resultConsumer = kittensOuters.showKitten;</pre>

      <p>The <code>searchBoxOuters</code> is the fake "global" scope
      created for that gadget, so
      <code>searchBoxOuters.searchEngine</code> is available to the
      gadget as <code>searchEngine</code>.</p>

      <p>Now the Gadgets can search the web.
    </li>

    <li class=slide id=status>
      <h1>Status as of 23 Feb 2008</h1>

      <p>Language Specification Solid</p>
      <p>Prototype Cajoler Implemented</p>
      <p>Prototype Tamed DOM</p>
      <p>Integrated w/ Shindig</p>
      <p>MySpace developer launch imminent</p>
      <p>Only Minimal Penetration Testing</p>
    </li>

    <li class=slide id=links>
      <h1>Caja &mdash; Links</h1>

      <div>Open Sourced under Apache license:
        <a href="http://code.google.com/p/google-caja/"
         >http://code.google.com/p/google-caja/</a></div>

      <div>Discussion Group:
        <a href="http://groups.google.com/group/google-caja-discuss"
         >http://groups.google.com/group/google-caja-discuss</a>

      <div>Demo App:
        <a href="http://tinyurl.com/2toxmm">http://tinyurl.com/2toxmm</a>

      <div>Demo App Source:
        <a href="http://tinyurl.com/22us8t">http://tinyurl.com/22us8t</a>
    </li>
  </ul>

</body>
</html>
